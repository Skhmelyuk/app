# –ì–∞–π–¥: –í—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (Message Replies)

–¶–µ–π –≥–∞–π–¥ —î –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è–º `DIRECT_MESSAGES_GUIDE.md` —ñ –æ–ø–∏—Å—É—î –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç—ñ.

---

## –ó–º—ñ—Å—Ç

1. [–û–≥–ª—è–¥ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É](#1-–æ–≥–ª—è–¥-—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É)
2. [–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ö–µ–º–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö](#2-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è-—Å—Ö–µ–º–∏-–±–∞–∑–∏-–¥–∞–Ω–∏—Ö)
3. [–û–Ω–æ–≤–ª–µ–Ω–Ω—è Convex —Ñ—É–Ω–∫—Ü—ñ–π](#3-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è-convex-—Ñ—É–Ω–∫—Ü—ñ–π)
4. [–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ ReplyPreview](#4-—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞-replypreview)
5. [–û–Ω–æ–≤–ª–µ–Ω–Ω—è MessageBubble](#5-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è-messagebubble)
6. [–û–Ω–æ–≤–ª–µ–Ω–Ω—è ChatInput](#6-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è-chatinput)
7. [–û–Ω–æ–≤–ª–µ–Ω–Ω—è –µ–∫—Ä–∞–Ω—É —á–∞—Ç—É](#7-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è-–µ–∫—Ä–∞–Ω—É-—á–∞—Ç—É)
8. [–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è](#8-–¥–æ–¥–∞—Ç–∫–æ–≤—ñ-–ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è)

---

## 1. –û–≥–ª—è–¥ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É

### –©–æ –±—É–¥–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ:

- **–°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ** –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
- **–î–æ–≤–≥–µ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è** –¥–ª—è –≤–∏–∫–ª–∏–∫—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –∑ –æ–ø—Ü—ñ—î—é "–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏"
- **–ü—Ä–µ–≤ º—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è** –Ω–∞–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥—É –ø—Ä–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
- **–í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ü–∏—Ç–∞—Ç–∏** –≤ –±—É–ª—å–±–∞—à—Ü—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è

### –í—ñ–∑—É–∞–ª—å–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ ‚Ü© –í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞: "–Ø–∫ —Å–ø—Ä–∞–≤–∏?"‚îÇ    ‚îÇ
‚îÇ  ‚îÇ –î–æ–±—Ä–µ, –¥—è–∫—É—é!               ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                       15:39 ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ √ó –í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞: –û–ª–µ–∫—Å–∞–Ω–¥—Ä   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ   "–Ø–∫ —Å–ø—Ä–∞–≤–∏?"              ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...        [>]  ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 2. –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ö–µ–º–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

### –ö—Ä–æ–∫ 2.1: –û–Ω–æ–≤—ñ—Ç—å —Ç–∞–±–ª–∏—Ü—é `messages` –≤ `convex/schema.ts`

–î–æ–¥–∞–π—Ç–µ –ø–æ–ª–µ `replyToId` –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –Ω–∞ —è–∫–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å:

```typescript
// convex/schema.ts

import { defineSchema, defineTable } from 'convex/server';
import { v } from 'convex/values';

export default defineSchema({
  // ... —ñ—Å–Ω—É—é—á—ñ —Ç–∞–±–ª–∏—Ü—ñ

  // –û–Ω–æ–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (messages)
  messages: defineTable({
    conversationId: v.id('conversations'),
    senderId: v.id('users'),
    content: v.optional(v.string()),
    imageUrl: v.optional(v.string()),
    storageId: v.optional(v.id('_storage')),
    isRead: v.boolean(),
    // –ù–û–í–ï: –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –Ω–∞ —è–∫–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å
    replyToId: v.optional(v.id('messages')),
  })
    .index('by_conversation', ['conversationId'])
    .index('by_sender', ['senderId']),
});
```

---

## 3. –û–Ω–æ–≤–ª–µ–Ω–Ω—è Convex —Ñ—É–Ω–∫—Ü—ñ–π

### –ö—Ä–æ–∫ 3.1: –û–Ω–æ–≤—ñ—Ç—å `convex/messages.ts`

#### 3.1.1: –û–Ω–æ–≤—ñ—Ç—å —Ñ—É–Ω–∫—Ü—ñ—é `getMessages`

–î–æ–¥–∞–π—Ç–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –Ω–∞ —è–∫–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å:

```typescript
// convex/messages.ts

import { v } from 'convex/values';
import { mutation, query } from './_generated/server';
import { getAuthUserId } from '@convex-dev/auth/server';

// –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥—ñ–∞–ª–æ–≥—É (–û–ù–û–í–õ–ï–ù–û)
export const getMessages = query({
  args: { conversationId: v.id('conversations') },
  handler: async (ctx, args) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) return [];

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –¥—ñ–∞–ª–æ–≥—É
    const conversation = await ctx.db.get(args.conversationId);
    if (!conversation) return [];

    if (conversation.participantOneId !== userId && conversation.participantTwoId !== userId) {
      return [];
    }

    const messages = await ctx.db
      .query('messages')
      .withIndex('by_conversation', (q) => q.eq('conversationId', args.conversationId))
      .order('asc')
      .collect();

    // –î–æ–¥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫–∞ —Ç–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è-–≤—ñ–¥–ø–æ–≤—ñ–¥—å
    const messagesWithDetails = await Promise.all(
      messages.map(async (message) => {
        const sender = await ctx.db.get(message.senderId);

        // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –Ω–∞ —è–∫–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å
        let replyTo = null;
        if (message.replyToId) {
          const replyMessage = await ctx.db.get(message.replyToId);
          if (replyMessage) {
            const replySender = await ctx.db.get(replyMessage.senderId);
            replyTo = {
              _id: replyMessage._id,
              content: replyMessage.content,
              imageUrl: replyMessage.imageUrl,
              sender: replySender
                ? {
                    _id: replySender._id,
                    username: replySender.username,
                  }
                : null,
            };
          }
        }

        return {
          ...message,
          sender: sender
            ? {
                _id: sender._id,
                username: sender.username,
                image: sender.image,
              }
            : null,
          isOwn: message.senderId === userId,
          replyTo,
        };
      })
    );

    return messagesWithDetails;
  },
});
```

#### 3.1.2: –û–Ω–æ–≤—ñ—Ç—å —Ñ—É–Ω–∫—Ü—ñ—é `sendMessage`

–î–æ–¥–∞–π—Ç–µ –ø—ñ–¥—Ç—Ä–∏–º–∫—É `replyToId`:

```typescript
// –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ç–µ–∫—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–û–ù–û–í–õ–ï–ù–û)
export const sendMessage = mutation({
  args: {
    conversationId: v.id('conversations'),
    content: v.string(),
    replyToId: v.optional(v.id('messages')), // –ù–û–í–ï
  },
  handler: async (ctx, args) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) throw new Error('Not authenticated');

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –¥—ñ–∞–ª–æ–≥—É
    const conversation = await ctx.db.get(args.conversationId);
    if (!conversation) throw new Error('Conversation not found');

    if (conversation.participantOneId !== userId && conversation.participantTwoId !== userId) {
      throw new Error('Access denied');
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —ñ—Å–Ω—É—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    if (args.replyToId) {
      const replyMessage = await ctx.db.get(args.replyToId);
      if (!replyMessage || replyMessage.conversationId !== args.conversationId) {
        throw new Error('Reply message not found');
      }
    }

    // –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    const messageId = await ctx.db.insert('messages', {
      conversationId: args.conversationId,
      senderId: userId,
      content: args.content,
      isRead: false,
      replyToId: args.replyToId, // –ù–û–í–ï
    });

    // –û–Ω–æ–≤–ª—é—î–º–æ –¥—ñ–∞–ª–æ–≥
    await ctx.db.patch(args.conversationId, {
      lastMessageId: messageId,
      lastMessageTime: Date.now(),
    });

    return messageId;
  },
});
```

#### 3.1.3: –û–Ω–æ–≤—ñ—Ç—å —Ñ—É–Ω–∫—Ü—ñ—é `sendImageMessage`

–î–æ–¥–∞–π—Ç–µ –ø—ñ–¥—Ç—Ä–∏–º–∫—É `replyToId`:

```typescript
// –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–û–ù–û–í–õ–ï–ù–û)
export const sendImageMessage = mutation({
  args: {
    conversationId: v.id('conversations'),
    storageId: v.id('_storage'),
    imageUrl: v.string(),
    replyToId: v.optional(v.id('messages')), // –ù–û–í–ï
  },
  handler: async (ctx, args) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) throw new Error('Not authenticated');

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –¥—ñ–∞–ª–æ–≥—É
    const conversation = await ctx.db.get(args.conversationId);
    if (!conversation) throw new Error('Conversation not found');

    if (conversation.participantOneId !== userId && conversation.participantTwoId !== userId) {
      throw new Error('Access denied');
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —ñ—Å–Ω—É—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    if (args.replyToId) {
      const replyMessage = await ctx.db.get(args.replyToId);
      if (!replyMessage || replyMessage.conversationId !== args.conversationId) {
        throw new Error('Reply message not found');
      }
    }

    // –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º
    const messageId = await ctx.db.insert('messages', {
      conversationId: args.conversationId,
      senderId: userId,
      imageUrl: args.imageUrl,
      storageId: args.storageId,
      isRead: false,
      replyToId: args.replyToId, // –ù–û–í–ï
    });

    // –û–Ω–æ–≤–ª—é—î–º–æ –¥—ñ–∞–ª–æ–≥
    await ctx.db.patch(args.conversationId, {
      lastMessageId: messageId,
      lastMessageTime: Date.now(),
    });

    return messageId;
  },
});
```

---

## 4. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ ReplyPreview

### –ö—Ä–æ–∫ 4.1: –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `components/ReplyPreview.tsx`

–¶–µ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –Ω–∞–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥—É –ø—Ä–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:

```tsx
// components/ReplyPreview.tsx

import { View, Text, TouchableOpacity, StyleSheet } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { COLORS } from '@/constants/theme';
import { Id } from '@/convex/_generated/dataModel';

interface ReplyPreviewProps {
  replyTo: {
    _id: Id<'messages'>;
    content?: string;
    imageUrl?: string;
    sender: {
      _id: Id<'users'>;
      username: string;
    } | null;
  };
  onCancel: () => void;
}

export const ReplyPreview = ({ replyTo, onCancel }: ReplyPreviewProps) => {
  const getPreviewText = () => {
    if (replyTo.imageUrl) return 'üì∑ –§–æ—Ç–æ';
    return replyTo.content || '';
  };

  return (
    <View style={styles.container}>
      <View style={styles.indicator} />

      <View style={styles.content}>
        <Text style={styles.replyingTo}>
          –í—ñ–¥–ø–æ–≤—ñ–¥—å –¥–ª—è{' '}
          <Text style={styles.username}>{replyTo.sender?.username || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</Text>
        </Text>
        <Text style={styles.messagePreview} numberOfLines={1}>
          {getPreviewText()}
        </Text>
      </View>

      <TouchableOpacity style={styles.closeButton} onPress={onCancel}>
        <Ionicons name="close" size={20} color={COLORS.grey} />
      </TouchableOpacity>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: COLORS.background,
    paddingHorizontal: 12,
    paddingVertical: 8,
    borderTopWidth: 0.5,
    borderTopColor: COLORS.grey,
  },
  indicator: {
    width: 3,
    height: '100%',
    backgroundColor: COLORS.primary,
    borderRadius: 2,
    marginRight: 10,
  },
  content: {
    flex: 1,
  },
  replyingTo: {
    fontSize: 12,
    color: COLORS.grey,
  },
  username: {
    color: COLORS.primary,
    fontWeight: '600',
  },
  messagePreview: {
    fontSize: 14,
    color: COLORS.white,
    marginTop: 2,
  },
  closeButton: {
    padding: 8,
  },
});
```

---

## 5. –û–Ω–æ–≤–ª–µ–Ω–Ω—è MessageBubble

### –ö—Ä–æ–∫ 5.1: –û–Ω–æ–≤—ñ—Ç—å —Ñ–∞–π–ª `components/MessageBubble.tsx`

–î–æ–¥–∞–π—Ç–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ü–∏—Ç–∞—Ç–∏ —Ç–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫—É —Å–≤–∞–π–ø—É/–¥–æ–≤–≥–æ–≥–æ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è:

```tsx
// components/MessageBubble.tsx

import { useRef } from 'react';
import {
  View,
  Text,
  StyleSheet,
  Dimensions,
  TouchableOpacity,
  Animated,
  PanResponder,
} from 'react-native';
import { Image } from 'expo-image';
import { format } from 'date-fns';
import { Ionicons } from '@expo/vector-icons';
import { COLORS } from '@/constants/theme';
import { Id } from '@/convex/_generated/dataModel';

const { width: SCREEN_WIDTH } = Dimensions.get('window');
const MAX_BUBBLE_WIDTH = SCREEN_WIDTH * 0.75;
const SWIPE_THRESHOLD = 60;

interface ReplyToType {
  _id: Id<'messages'>;
  content?: string;
  imageUrl?: string;
  sender: {
    _id: Id<'users'>;
    username: string;
  } | null;
}

interface MessageBubbleProps {
  message: {
    _id: Id<'messages'>;
    content?: string;
    imageUrl?: string;
    isOwn: boolean;
    isRead: boolean;
    _creationTime: number;
    sender: {
      _id: Id<'users'>;
      username: string;
      image: string;
    } | null;
    replyTo?: ReplyToType | null;
  };
  onReply?: (message: MessageBubbleProps['message']) => void;
  onScrollToMessage?: (messageId: Id<'messages'>) => void;
}

export const MessageBubble = ({ message, onReply, onScrollToMessage }: MessageBubbleProps) => {
  const { isOwn, content, imageUrl, _creationTime, isRead, replyTo } = message;

  // –ê–Ω—ñ–º–∞—Ü—ñ—è –¥–ª—è —Å–≤–∞–π–ø—É
  const translateX = useRef(new Animated.Value(0)).current;
  const replyIconOpacity = useRef(new Animated.Value(0)).current;

  const panResponder = useRef(
    PanResponder.create({
      onStartShouldSetPanResponder: () => false,
      onMoveShouldSetPanResponder: (_, gestureState) => {
        // –ê–∫—Ç–∏–≤—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–≤–∞–π–ø—É –≤–ø—Ä–∞–≤–æ
        return gestureState.dx > 10 && Math.abs(gestureState.dy) < 20;
      },
      onPanResponderMove: (_, gestureState) => {
        if (gestureState.dx > 0 && gestureState.dx <= SWIPE_THRESHOLD) {
          translateX.setValue(gestureState.dx);
          replyIconOpacity.setValue(gestureState.dx / SWIPE_THRESHOLD);
        }
      },
      onPanResponderRelease: (_, gestureState) => {
        if (gestureState.dx >= SWIPE_THRESHOLD && onReply) {
          // –í–∏–∫–ª–∏–∫–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
          onReply(message);
        }

        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–∞ –º—ñ—Å—Ü–µ
        Animated.parallel([
          Animated.spring(translateX, {
            toValue: 0,
            useNativeDriver: true,
          }),
          Animated.timing(replyIconOpacity, {
            toValue: 0,
            duration: 200,
            useNativeDriver: true,
          }),
        ]).start();
      },
    })
  ).current;

  const handleLongPress = () => {
    if (onReply) {
      onReply(message);
    }
  };

  const handleReplyPress = () => {
    if (replyTo && onScrollToMessage) {
      onScrollToMessage(replyTo._id);
    }
  };

  const getReplyPreviewText = () => {
    if (!replyTo) return '';
    if (replyTo.imageUrl) return 'üì∑ –§–æ—Ç–æ';
    return replyTo.content || '';
  };

  return (
    <View style={[styles.wrapper, isOwn ? styles.ownWrapper : styles.otherWrapper]}>
      {/* –Ü–∫–æ–Ω–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø—Ä–∏ —Å–≤–∞–π–ø—ñ */}
      <Animated.View
        style={[
          styles.replyIconContainer,
          {
            opacity: replyIconOpacity,
            transform: [{ scale: replyIconOpacity }],
          },
        ]}
      >
        <Ionicons name="arrow-undo" size={20} color={COLORS.primary} />
      </Animated.View>

      <Animated.View
        style={[
          styles.container,
          isOwn ? styles.ownContainer : styles.otherContainer,
          { transform: [{ translateX }] },
        ]}
        {...panResponder.panHandlers}
      >
        {!isOwn && message.sender && (
          <Image source={message.sender.image} style={styles.avatar} contentFit="cover" />
        )}

        <TouchableOpacity
          style={[styles.bubble, isOwn ? styles.ownBubble : styles.otherBubble]}
          onLongPress={handleLongPress}
          delayLongPress={300}
          activeOpacity={0.8}
        >
          {/* –¶–∏—Ç–∞—Ç–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –Ω–∞ —è–∫–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å */}
          {replyTo && (
            <TouchableOpacity style={styles.replyContainer} onPress={handleReplyPress}>
              <View style={styles.replyIndicator} />
              <View style={styles.replyContent}>
                <Text style={styles.replyUsername}>{replyTo.sender?.username || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</Text>
                <Text style={styles.replyText} numberOfLines={1}>
                  {getReplyPreviewText()}
                </Text>
              </View>
            </TouchableOpacity>
          )}

          {imageUrl && (
            <Image source={imageUrl} style={styles.image} contentFit="cover" transition={200} />
          )}

          {content && (
            <Text style={[styles.text, isOwn ? styles.ownText : styles.otherText]}>{content}</Text>
          )}

          <View style={styles.footer}>
            <Text style={[styles.time, isOwn ? styles.ownTime : styles.otherTime]}>
              {format(_creationTime, 'HH:mm')}
            </Text>
            {isOwn && <Text style={styles.readStatus}>{isRead ? '‚úì‚úì' : '‚úì'}</Text>}
          </View>
        </TouchableOpacity>
      </Animated.View>
    </View>
  );
};

const styles = StyleSheet.create({
  wrapper: {
    flexDirection: 'row',
    alignItems: 'center',
    marginVertical: 4,
    paddingHorizontal: 12,
  },
  ownWrapper: {
    justifyContent: 'flex-end',
  },
  otherWrapper: {
    justifyContent: 'flex-start',
  },
  replyIconContainer: {
    position: 'absolute',
    left: 16,
    width: 36,
    height: 36,
    borderRadius: 18,
    backgroundColor: 'rgba(0, 149, 246, 0.2)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  container: {
    flexDirection: 'row',
    maxWidth: MAX_BUBBLE_WIDTH,
  },
  ownContainer: {
    justifyContent: 'flex-end',
  },
  otherContainer: {
    justifyContent: 'flex-start',
  },
  avatar: {
    width: 32,
    height: 32,
    borderRadius: 16,
    marginRight: 8,
  },
  bubble: {
    borderRadius: 16,
    padding: 12,
    maxWidth: MAX_BUBBLE_WIDTH - 40,
  },
  ownBubble: {
    backgroundColor: COLORS.primary,
    borderBottomRightRadius: 4,
  },
  otherBubble: {
    backgroundColor: '#333',
    borderBottomLeftRadius: 4,
  },
  // –°—Ç–∏–ª—ñ –¥–ª—è —Ü–∏—Ç–∞—Ç–∏
  replyContainer: {
    flexDirection: 'row',
    backgroundColor: 'rgba(0, 0, 0, 0.2)',
    borderRadius: 8,
    padding: 8,
    marginBottom: 8,
  },
  replyIndicator: {
    width: 3,
    backgroundColor: COLORS.primary,
    borderRadius: 2,
    marginRight: 8,
  },
  replyContent: {
    flex: 1,
  },
  replyUsername: {
    fontSize: 12,
    fontWeight: '600',
    color: COLORS.primary,
    marginBottom: 2,
  },
  replyText: {
    fontSize: 13,
    color: 'rgba(255, 255, 255, 0.7)',
  },
  image: {
    width: MAX_BUBBLE_WIDTH - 64,
    height: 200,
    borderRadius: 8,
    marginBottom: 8,
  },
  text: {
    fontSize: 16,
    lineHeight: 22,
  },
  ownText: {
    color: COLORS.white,
  },
  otherText: {
    color: COLORS.white,
  },
  footer: {
    flexDirection: 'row',
    justifyContent: 'flex-end',
    alignItems: 'center',
    marginTop: 4,
  },
  time: {
    fontSize: 11,
  },
  ownTime: {
    color: 'rgba(255, 255, 255, 0.7)',
  },
  otherTime: {
    color: 'rgba(255, 255, 255, 0.5)',
  },
  readStatus: {
    fontSize: 11,
    color: 'rgba(255, 255, 255, 0.7)',
    marginLeft: 4,
  },
});
```

---

## 6. –û–Ω–æ–≤–ª–µ–Ω–Ω—è ChatInput

### –ö—Ä–æ–∫ 6.1: –û–Ω–æ–≤—ñ—Ç—å —Ñ–∞–π–ª `components/ChatInput.tsx`

–î–æ–¥–∞–π—Ç–µ –ø—ñ–¥—Ç—Ä–∏–º–∫—É `replyToId`:

```tsx
// components/ChatInput.tsx

import { useState } from 'react';
import { View, TextInput, TouchableOpacity, StyleSheet, ActivityIndicator } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import * as ImagePicker from 'expo-image-picker';
import { COLORS } from '@/constants/theme';
import { Id } from '@/convex/_generated/dataModel';

interface ChatInputProps {
  onSendText: (text: string, replyToId?: Id<'messages'>) => Promise<void>;
  onSendImage: (uri: string, replyToId?: Id<'messages'>) => Promise<void>;
  replyToId?: Id<'messages'>;
  disabled?: boolean;
}

export const ChatInput = ({ onSendText, onSendImage, replyToId, disabled }: ChatInputProps) => {
  const [text, setText] = useState('');
  const [isSending, setIsSending] = useState(false);

  const handleSendText = async () => {
    if (!text.trim() || isSending) return;

    setIsSending(true);
    try {
      await onSendText(text.trim(), replyToId);
      setText('');
    } catch (error) {
      console.error('Error sending message:', error);
    } finally {
      setIsSending(false);
    }
  };

  const handlePickImage = async () => {
    if (isSending) return;

    const result = await ImagePicker.launchImageLibraryAsync({
      mediaTypes: ImagePicker.MediaTypeOptions.Images,
      allowsEditing: true,
      quality: 0.8,
    });

    if (!result.canceled && result.assets[0]) {
      setIsSending(true);
      try {
        await onSendImage(result.assets[0].uri, replyToId);
      } catch (error) {
        console.error('Error sending image:', error);
      } finally {
        setIsSending(false);
      }
    }
  };

  return (
    <View style={styles.container}>
      <TouchableOpacity
        style={styles.iconButton}
        onPress={handlePickImage}
        disabled={disabled || isSending}
      >
        <Ionicons name="image-outline" size={24} color={COLORS.primary} />
      </TouchableOpacity>

      <TextInput
        style={styles.input}
        value={text}
        onChangeText={setText}
        placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."
        placeholderTextColor={COLORS.grey}
        multiline
        maxLength={1000}
        editable={!disabled && !isSending}
      />

      <TouchableOpacity
        style={[styles.sendButton, (!text.trim() || isSending) && styles.sendButtonDisabled]}
        onPress={handleSendText}
        disabled={!text.trim() || disabled || isSending}
      >
        {isSending ? (
          <ActivityIndicator size="small" color={COLORS.white} />
        ) : (
          <Ionicons name="send" size={20} color={COLORS.white} />
        )}
      </TouchableOpacity>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    alignItems: 'flex-end',
    padding: 8,
    backgroundColor: COLORS.background,
    borderTopWidth: 0.5,
    borderTopColor: COLORS.grey,
  },
  iconButton: {
    padding: 8,
    marginRight: 4,
  },
  input: {
    flex: 1,
    backgroundColor: '#2a2a2a',
    borderRadius: 20,
    paddingHorizontal: 16,
    paddingVertical: 10,
    fontSize: 16,
    color: COLORS.white,
    maxHeight: 100,
  },
  sendButton: {
    backgroundColor: COLORS.primary,
    width: 40,
    height: 40,
    borderRadius: 20,
    justifyContent: 'center',
    alignItems: 'center',
    marginLeft: 8,
  },
  sendButtonDisabled: {
    opacity: 0.5,
  },
});
```

---

## 7. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –µ–∫—Ä–∞–Ω—É —á–∞—Ç—É

### –ö—Ä–æ–∫ 7.1: –û–Ω–æ–≤—ñ—Ç—å —Ñ–∞–π–ª `app/chat/[id].tsx`

–ü–æ–≤–Ω–∞ –≤–µ—Ä—Å—ñ—è –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π:

```tsx
// app/chat/[id].tsx

import { useEffect, useRef, useState, useCallback } from 'react';
import {
  View,
  FlatList,
  StyleSheet,
  KeyboardAvoidingView,
  Platform,
  TouchableOpacity,
  Text,
} from 'react-native';
import { useLocalSearchParams, useRouter } from 'expo-router';
import { useQuery, useMutation } from 'convex/react';
import { api } from '@/convex/_generated/api';
import { Id } from '@/convex/_generated/dataModel';
import { MessageBubble } from '@/components/MessageBubble';
import { ChatInput } from '@/components/ChatInput';
import { ReplyPreview } from '@/components/ReplyPreview';
import { Loader } from '@/components/Loader';
import { COLORS } from '@/constants/theme';
import { Ionicons } from '@expo/vector-icons';
import { Image } from 'expo-image';

// –¢–∏–ø –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
interface MessageType {
  _id: Id<'messages'>;
  content?: string;
  imageUrl?: string;
  isOwn: boolean;
  isRead: boolean;
  _creationTime: number;
  sender: {
    _id: Id<'users'>;
    username: string;
    image: string;
  } | null;
  replyTo?: {
    _id: Id<'messages'>;
    content?: string;
    imageUrl?: string;
    sender: {
      _id: Id<'users'>;
      username: string;
    } | null;
  } | null;
}

export default function ChatScreen() {
  const { id } = useLocalSearchParams<{ id: string }>();
  const router = useRouter();
  const flatListRef = useRef<FlatList>(null);

  // –°—Ç–∞–Ω –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
  const [replyTo, setReplyTo] = useState<MessageType | null>(null);

  const conversationId = id as Id<'conversations'>;

  const conversation = useQuery(api.conversations.getConversation, {
    conversationId,
  });
  const messages = useQuery(api.messages.getMessages, { conversationId });

  const sendMessage = useMutation(api.messages.sendMessage);
  const sendImageMessage = useMutation(api.messages.sendImageMessage);
  const generateUploadUrl = useMutation(api.messages.generateUploadUrl);
  const markAsRead = useMutation(api.messages.markAsRead);

  // –ü–æ–∑–Ω–∞—á–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —è–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω—ñ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —á–∞—Ç—É
  useEffect(() => {
    if (conversationId) {
      markAsRead({ conversationId });
    }
  }, [conversationId, messages]);

  // –ü—Ä–æ–∫—Ä—É—á—É—î–º–æ –¥–æ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
  useEffect(() => {
    if (messages && messages.length > 0) {
      setTimeout(() => {
        flatListRef.current?.scrollToEnd({ animated: true });
      }, 100);
    }
  }, [messages]);

  // –û–±—Ä–æ–±–Ω–∏–∫ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
  const handleReply = useCallback((message: MessageType) => {
    setReplyTo(message);
  }, []);

  // –°–∫–∞—Å—É–≤–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
  const handleCancelReply = useCallback(() => {
    setReplyTo(null);
  }, []);

  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –Ω–∞ —Ü–∏—Ç–∞—Ç—É
  const handleScrollToMessage = useCallback(
    (messageId: Id<'messages'>) => {
      if (!messages) return;

      const index = messages.findIndex((m) => m._id === messageId);
      if (index !== -1) {
        flatListRef.current?.scrollToIndex({
          index,
          animated: true,
          viewPosition: 0.5,
        });
      }
    },
    [messages]
  );

  const handleSendText = async (text: string, replyToId?: Id<'messages'>) => {
    await sendMessage({
      conversationId,
      content: text,
      replyToId,
    });
    setReplyTo(null); // –°–∫–∏–¥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
  };

  const handleSendImage = async (uri: string, replyToId?: Id<'messages'>) => {
    try {
      // –û—Ç—Ä–∏–º—É—î–º–æ URL –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
      const uploadUrl = await generateUploadUrl();

      // –ß–∏—Ç–∞—î–º–æ —Ñ–∞–π–ª
      const response = await fetch(uri);
      const blob = await response.blob();

      // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      const uploadResponse = await fetch(uploadUrl, {
        method: 'POST',
        headers: { 'Content-Type': blob.type },
        body: blob,
      });

      const { storageId } = await uploadResponse.json();

      // –û—Ç—Ä–∏–º—É—î–º–æ URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
      const imageUrl = `${process.env.EXPO_PUBLIC_CONVEX_URL}/api/storage/${storageId}`;

      // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º
      await sendImageMessage({
        conversationId,
        storageId,
        imageUrl,
        replyToId,
      });

      setReplyTo(null); // –°–∫–∏–¥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
    } catch (error) {
      console.error('Error uploading image:', error);
    }
  };

  if (conversation === undefined || messages === undefined) {
    return <Loader />;
  }

  if (!conversation) {
    return (
      <View style={styles.errorContainer}>
        <Text style={styles.errorText}>–î—ñ–∞–ª–æ–≥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</Text>
      </View>
    );
  }

  return (
    <KeyboardAvoidingView
      style={styles.container}
      behavior={Platform.OS === 'ios' ? 'padding' : undefined}
      keyboardVerticalOffset={90}
    >
      {/* Header */}
      <View style={styles.header}>
        <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>
          <Ionicons name="arrow-back" size={24} color={COLORS.white} />
        </TouchableOpacity>

        {conversation.otherUser && (
          <TouchableOpacity
            style={styles.userInfo}
            onPress={() => router.push(`/user/${conversation.otherUser?._id}`)}
          >
            <Image source={conversation.otherUser.image} style={styles.avatar} contentFit="cover" />
            <View>
              <Text style={styles.username}>{conversation.otherUser.username}</Text>
              <Text style={styles.fullname}>{conversation.otherUser.fullname}</Text>
            </View>
          </TouchableOpacity>
        )}
      </View>

      {/* Messages */}
      <FlatList
        ref={flatListRef}
        data={messages}
        keyExtractor={(item) => item._id}
        renderItem={({ item }) => (
          <MessageBubble
            message={item}
            onReply={handleReply}
            onScrollToMessage={handleScrollToMessage}
          />
        )}
        contentContainerStyle={styles.messagesList}
        showsVerticalScrollIndicator={false}
        onContentSizeChange={() => flatListRef.current?.scrollToEnd({ animated: false })}
        onScrollToIndexFailed={(info) => {
          // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
          setTimeout(() => {
            flatListRef.current?.scrollToIndex({
              index: info.index,
              animated: true,
            });
          }, 100);
        }}
      />

      {/* Reply Preview */}
      {replyTo && (
        <ReplyPreview
          replyTo={{
            _id: replyTo._id,
            content: replyTo.content,
            imageUrl: replyTo.imageUrl,
            sender: replyTo.sender,
          }}
          onCancel={handleCancelReply}
        />
      )}

      {/* Input */}
      <ChatInput
        onSendText={handleSendText}
        onSendImage={handleSendImage}
        replyToId={replyTo?._id}
      />
    </KeyboardAvoidingView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: COLORS.background,
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 12,
    borderBottomWidth: 0.5,
    borderBottomColor: COLORS.grey,
    paddingTop: 50,
  },
  backButton: {
    padding: 8,
    marginRight: 8,
  },
  userInfo: {
    flexDirection: 'row',
    alignItems: 'center',
    flex: 1,
  },
  avatar: {
    width: 40,
    height: 40,
    borderRadius: 20,
    marginRight: 12,
  },
  username: {
    fontSize: 16,
    fontWeight: '600',
    color: COLORS.white,
  },
  fullname: {
    fontSize: 12,
    color: COLORS.grey,
  },
  messagesList: {
    paddingVertical: 16,
  },
  errorContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: COLORS.background,
  },
  errorText: {
    color: COLORS.white,
    fontSize: 16,
  },
});
```

---

## 8. –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è

### 8.1: –í—ñ–±—Ä–∞—Ü—ñ—è –ø—Ä–∏ —Å–≤–∞–π–ø—ñ

–î–æ–¥–∞–π—Ç–µ —Ç–∞–∫—Ç–∏–ª—å–Ω–∏–π –≤—ñ–¥–≥—É–∫ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:

```tsx
// –í MessageBubble.tsx

import * as Haptics from 'expo-haptics';

// –í onPanResponderRelease:
if (gestureState.dx >= SWIPE_THRESHOLD && onReply) {
  Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);
  onReply(message);
}
```

### 8.2: –ü—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç—Ü—ñ

–î–æ–¥–∞–π—Ç–µ –∞–Ω—ñ–º–∞—Ü—ñ—é –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –¥–æ —Ü–∏—Ç–æ–≤–∞–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:

```tsx
// –í MessageBubble.tsx

const [isHighlighted, setIsHighlighted] = useState(false);

// –î–æ–¥–∞–π—Ç–µ prop highlightedMessageId —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ:
useEffect(() => {
  if (highlightedMessageId === message._id) {
    setIsHighlighted(true);
    setTimeout(() => setIsHighlighted(false), 1500);
  }
}, [highlightedMessageId]);

// –í —Å—Ç–∏–ª—è—Ö bubble:
<View style={[
  styles.bubble,
  isOwn ? styles.ownBubble : styles.otherBubble,
  isHighlighted && styles.highlightedBubble,
]}>

// –°—Ç–∏–ª—å:
highlightedBubble: {
  backgroundColor: 'rgba(0, 149, 246, 0.3)',
}
```

### 8.3: –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é –∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º–∏ –æ–ø—Ü—ñ—è–º–∏

```tsx
// –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ react-native-context-menu-view –∞–±–æ –≤–ª–∞—Å–Ω–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ

import ContextMenu from 'react-native-context-menu-view';

<ContextMenu
  actions={[
    { title: '–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏', systemIcon: 'arrowshape.turn.up.left' },
    { title: '–ö–æ–ø—ñ—é–≤–∞—Ç–∏', systemIcon: 'doc.on.doc' },
    { title: '–í–∏–¥–∞–ª–∏—Ç–∏', systemIcon: 'trash', destructive: true },
  ]}
  onPress={(e) => {
    if (e.nativeEvent.name === '–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏') {
      onReply?.(message);
    }
    // ... —ñ–Ω—à—ñ –¥—ñ—ó
  }}
>
  {/* Bubble content */}
</ContextMenu>;
```

---

## –ß–µ–∫-–ª–∏—Å—Ç –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è

- [ ] –û–Ω–æ–≤–∏—Ç–∏ `convex/schema.ts` (–¥–æ–¥–∞—Ç–∏ `replyToId` –≤ —Ç–∞–±–ª–∏—Ü—é `messages`)
- [ ] –û–Ω–æ–≤–∏—Ç–∏ `convex/messages.ts`:
  - [ ] –û–Ω–æ–≤–∏—Ç–∏ `getMessages` –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è `replyTo`
  - [ ] –û–Ω–æ–≤–∏—Ç–∏ `sendMessage` –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é `replyToId`
  - [ ] –û–Ω–æ–≤–∏—Ç–∏ `sendImageMessage` –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é `replyToId`
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `components/ReplyPreview.tsx`
- [ ] –û–Ω–æ–≤–∏—Ç–∏ `components/MessageBubble.tsx`:
  - [ ] –î–æ–¥–∞—Ç–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ü–∏—Ç–∞—Ç–∏
  - [ ] –î–æ–¥–∞—Ç–∏ —Å–≤–∞–π–ø –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
  - [ ] –î–æ–¥–∞—Ç–∏ –¥–æ–≤–≥–µ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è
- [ ] –û–Ω–æ–≤–∏—Ç–∏ `components/ChatInput.tsx` (–ø—ñ–¥—Ç—Ä–∏–º–∫–∞ `replyToId`)
- [ ] –û–Ω–æ–≤–∏—Ç–∏ `app/chat/[id].tsx`:
  - [ ] –î–æ–¥–∞—Ç–∏ —Å—Ç–∞–Ω `replyTo`
  - [ ] –î–æ–¥–∞—Ç–∏ `ReplyPreview`
  - [ ] –ü–µ—Ä–µ–¥–∞—Ç–∏ props –≤ `MessageBubble`
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç–∏ `npx convex dev` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó —Å—Ö–µ–º–∏
- [ ] –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ):
  - [ ] `expo install expo-haptics`
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª

---

## –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏ —Ç–∞ —Ä—ñ—à–µ–Ω–Ω—è

### –ü—Ä–æ–±–ª–µ–º–∞: –°–≤–∞–π–ø –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É—î –∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–æ—é —Å–ø–∏—Å–∫—É

**–†—ñ—à–µ–Ω–Ω—è:** –ù–∞–ª–∞—à—Ç—É–π—Ç–µ `onMoveShouldSetPanResponder` –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º—É —Ä—É—Å—ñ:

```tsx
onMoveShouldSetPanResponder: (_, gestureState) => {
  return gestureState.dx > 10 && Math.abs(gestureState.dy) < 20;
};
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç—Ü—ñ –¥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è

**–†—ñ—à–µ–Ω–Ω—è:** –î–æ–¥–∞–π—Ç–µ –æ–±—Ä–æ–±–Ω–∏–∫ `onScrollToIndexFailed`:

```tsx
onScrollToIndexFailed={(info) => {
  setTimeout(() => {
    flatListRef.current?.scrollToIndex({
      index: info.index,
      animated: true,
    });
  }, 100);
}}
```

### –ü—Ä–æ–±–ª–µ–º–∞: –¶–∏—Ç–∞—Ç–∞ –Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å

**–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Å—Ö–µ–º–∞ –æ–Ω–æ–≤–ª–µ–Ω–∞ —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–æ –º—ñ–≥—Ä–∞—Ü—ñ—é –¥–∞–Ω–∏—Ö.

---

## –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

–ü—ñ—Å–ª—è –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏:

1. **–ü–µ—Ä–µ—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å** –≤ —ñ–Ω—à—ñ —á–∞—Ç–∏
2. **–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å**
3. **–í–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å**
4. **–†–µ–∞–∫—Ü—ñ—ó –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è** (–µ–º–æ–¥–∑—ñ)
5. **–ì–æ–ª–æ—Å–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è**

---
