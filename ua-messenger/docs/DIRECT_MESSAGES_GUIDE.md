# –ì–∞–π–¥: –î–æ–¥–∞–≤–∞–Ω–Ω—è Direct Messages (–ü—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è)

–¶–µ–π –≥–∞–π–¥ –æ–ø–∏—Å—É—î –ø–æ–∫—Ä–æ–∫–æ–≤–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É –ø—Ä–∏–≤–∞—Ç–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —É –¥–æ–¥–∞—Ç–æ–∫ **ua-messenger**.

---

## –ó–º—ñ—Å—Ç

1. [–û–≥–ª—è–¥ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏](#1-–æ–≥–ª—è–¥-–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏)
2. [–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ö–µ–º–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö (Convex)](#2-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è-—Å—Ö–µ–º–∏-–±–∞–∑–∏-–¥–∞–Ω–∏—Ö-convex)
3. [–°—Ç–≤–æ—Ä–µ–Ω–Ω—è Convex —Ñ—É–Ω–∫—Ü—ñ–π](#3-—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è-convex-—Ñ—É–Ω–∫—Ü—ñ–π)
4. [–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ UI](#4-—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤-ui)
5. [–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –µ–∫—Ä–∞–Ω—ñ–≤](#5-—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è-–µ–∫—Ä–∞–Ω—ñ–≤)
6. [–û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó](#6-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è-–Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó)
7. [–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è](#7-–¥–æ–¥–∞—Ç–∫–æ–≤—ñ-–ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è)

---

## 1. –û–≥–ª—è–¥ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É:

```
Direct Messages
‚îú‚îÄ‚îÄ –°–ø–∏—Å–æ–∫ –¥—ñ–∞–ª–æ–≥—ñ–≤ (conversations)
‚îú‚îÄ‚îÄ –ï–∫—Ä–∞–Ω —á–∞—Ç—É (chat)
‚îÇ   ‚îú‚îÄ‚îÄ –¢–µ–∫—Å—Ç–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
‚îÇ   ‚îî‚îÄ‚îÄ –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è
‚îî‚îÄ‚îÄ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –¥—ñ–∞–ª–æ–≥—É
```

### –ù–æ–≤—ñ —Ñ–∞–π–ª–∏, —è–∫—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏:

```
convex/
‚îú‚îÄ‚îÄ conversations.ts      # –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –¥—ñ–∞–ª–æ–≥—ñ–≤
‚îú‚îÄ‚îÄ messages.ts           # –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å

components/
‚îú‚îÄ‚îÄ ConversationItem.tsx  # –ï–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫—É –¥—ñ–∞–ª–æ–≥—ñ–≤
‚îú‚îÄ‚îÄ MessageBubble.tsx     # –ë—É–ª—å–±–∞—à–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
‚îú‚îÄ‚îÄ ChatInput.tsx         # –ü–æ–ª–µ –≤–≤–æ–¥—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
‚îî‚îÄ‚îÄ ImageMessagePicker.tsx # –í–∏–±—ñ—Ä –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏

app/
‚îú‚îÄ‚îÄ (tabs)/
‚îÇ   ‚îî‚îÄ‚îÄ messages.tsx      # –°–ø–∏—Å–æ–∫ –¥—ñ–∞–ª–æ–≥—ñ–≤ (–Ω–æ–≤–∏–π —Ç–∞–±)
‚îî‚îÄ‚îÄ chat/
    ‚îî‚îÄ‚îÄ [id].tsx          # –ï–∫—Ä–∞–Ω —á–∞—Ç—É
```

---

## 2. –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ö–µ–º–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö (Convex)

### –ö—Ä–æ–∫ 2.1: –û–Ω–æ–≤—ñ—Ç—å —Ñ–∞–π–ª `convex/schema.ts`

–î–æ–¥–∞–π—Ç–µ –Ω–æ–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ –≤ –∫—ñ–Ω–µ—Ü—å —Å—Ö–µ–º–∏:

```typescript
// convex/schema.ts

import { defineSchema, defineTable } from 'convex/server';
import { v } from 'convex/values';

export default defineSchema({
  // ... —ñ—Å–Ω—É—é—á—ñ —Ç–∞–±–ª–∏—Ü—ñ (users, posts, likes, comments, follows, notifications, bookmarks)

  // –¢–∞–±–ª–∏—Ü—è –¥—ñ–∞–ª–æ–≥—ñ–≤ (conversations)
  conversations: defineTable({
    participantOneId: v.id('users'),
    participantTwoId: v.id('users'),
    lastMessageId: v.optional(v.id('messages')),
    lastMessageTime: v.optional(v.number()),
  })
    .index('by_participant_one', ['participantOneId'])
    .index('by_participant_two', ['participantTwoId'])
    .index('by_participants', ['participantOneId', 'participantTwoId']),

  // –¢–∞–±–ª–∏—Ü—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (messages)
  messages: defineTable({
    conversationId: v.id('conversations'),
    senderId: v.id('users'),
    content: v.optional(v.string()), // –¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    imageUrl: v.optional(v.string()), // URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    storageId: v.optional(v.id('_storage')), // ID —Ñ–∞–π–ª—É –≤ storage
    isRead: v.boolean(),
  })
    .index('by_conversation', ['conversationId'])
    .index('by_sender', ['senderId']),
});
```

---

## 3. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Convex —Ñ—É–Ω–∫—Ü—ñ–π

### –ö—Ä–æ–∫ 3.1: –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `convex/conversations.ts`

```typescript
// convex/conversations.ts

import { v } from 'convex/values';
import { mutation, query } from './_generated/server';
import { getAuthUserId } from '@convex-dev/auth/server';

// –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ –¥—ñ–∞–ª–æ–≥–∏ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
export const getConversations = query({
  args: {},
  handler: async (ctx) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) return [];

    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –¥—ñ–∞–ª–æ–≥–∏, –¥–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —î —É—á–∞—Å–Ω–∏–∫–æ–º
    const conversationsAsOne = await ctx.db
      .query('conversations')
      .withIndex('by_participant_one', (q) => q.eq('participantOneId', userId))
      .collect();

    const conversationsAsTwo = await ctx.db
      .query('conversations')
      .withIndex('by_participant_two', (q) => q.eq('participantTwoId', userId))
      .collect();

    const allConversations = [...conversationsAsOne, ...conversationsAsTwo];

    // –°–æ—Ä—Ç—É—î–º–æ –∑–∞ —á–∞—Å–æ–º –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    allConversations.sort((a, b) => {
      const timeA = a.lastMessageTime || a._creationTime;
      const timeB = b.lastMessageTime || b._creationTime;
      return timeB - timeA;
    });

    // –î–æ–¥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞ —Ç–∞ –æ—Å—Ç–∞–Ω–Ω—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    const conversationsWithDetails = await Promise.all(
      allConversations.map(async (conversation) => {
        const otherUserId =
          conversation.participantOneId === userId
            ? conversation.participantTwoId
            : conversation.participantOneId;

        const otherUser = await ctx.db.get(otherUserId);

        let lastMessage = null;
        if (conversation.lastMessageId) {
          lastMessage = await ctx.db.get(conversation.lastMessageId);
        }

        // –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        const unreadMessages = await ctx.db
          .query('messages')
          .withIndex('by_conversation', (q) => q.eq('conversationId', conversation._id))
          .filter((q) => q.and(q.eq(q.field('isRead'), false), q.neq(q.field('senderId'), userId)))
          .collect();

        return {
          ...conversation,
          otherUser: otherUser
            ? {
                _id: otherUser._id,
                username: otherUser.username,
                fullname: otherUser.fullname,
                image: otherUser.image,
              }
            : null,
          lastMessage: lastMessage
            ? {
                content: lastMessage.content,
                imageUrl: lastMessage.imageUrl,
                senderId: lastMessage.senderId,
                _creationTime: lastMessage._creationTime,
              }
            : null,
          unreadCount: unreadMessages.length,
        };
      })
    );

    return conversationsWithDetails;
  },
});

// –û—Ç—Ä–∏–º–∞—Ç–∏ –∞–±–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –¥—ñ–∞–ª–æ–≥ –∑ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º
export const getOrCreateConversation = mutation({
  args: { otherUserId: v.id('users') },
  handler: async (ctx, args) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) throw new Error('Not authenticated');

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —ñ—Å–Ω—É—î –¥—ñ–∞–ª–æ–≥
    const existingConversation1 = await ctx.db
      .query('conversations')
      .withIndex('by_participants', (q) =>
        q.eq('participantOneId', userId).eq('participantTwoId', args.otherUserId)
      )
      .first();

    if (existingConversation1) return existingConversation1._id;

    const existingConversation2 = await ctx.db
      .query('conversations')
      .withIndex('by_participants', (q) =>
        q.eq('participantOneId', args.otherUserId).eq('participantTwoId', userId)
      )
      .first();

    if (existingConversation2) return existingConversation2._id;

    // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –¥—ñ–∞–ª–æ–≥
    const conversationId = await ctx.db.insert('conversations', {
      participantOneId: userId,
      participantTwoId: args.otherUserId,
    });

    return conversationId;
  },
});

// –û—Ç—Ä–∏–º–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ –¥—ñ–∞–ª–æ–≥—É
export const getConversation = query({
  args: { conversationId: v.id('conversations') },
  handler: async (ctx, args) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) return null;

    const conversation = await ctx.db.get(args.conversationId);
    if (!conversation) return null;

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —î —É—á–∞—Å–Ω–∏–∫–æ–º
    if (conversation.participantOneId !== userId && conversation.participantTwoId !== userId) {
      return null;
    }

    const otherUserId =
      conversation.participantOneId === userId
        ? conversation.participantTwoId
        : conversation.participantOneId;

    const otherUser = await ctx.db.get(otherUserId);

    return {
      ...conversation,
      otherUser: otherUser
        ? {
            _id: otherUser._id,
            username: otherUser.username,
            fullname: otherUser.fullname,
            image: otherUser.image,
          }
        : null,
    };
  },
});
```

### –ö—Ä–æ–∫ 3.2: –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `convex/messages.ts`

```typescript
// convex/messages.ts

import { v } from 'convex/values';
import { mutation, query } from './_generated/server';
import { getAuthUserId } from '@convex-dev/auth/server';

// –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥—ñ–∞–ª–æ–≥—É
export const getMessages = query({
  args: { conversationId: v.id('conversations') },
  handler: async (ctx, args) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) return [];

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –¥—ñ–∞–ª–æ–≥—É
    const conversation = await ctx.db.get(args.conversationId);
    if (!conversation) return [];

    if (conversation.participantOneId !== userId && conversation.participantTwoId !== userId) {
      return [];
    }

    const messages = await ctx.db
      .query('messages')
      .withIndex('by_conversation', (q) => q.eq('conversationId', args.conversationId))
      .order('asc')
      .collect();

    // –î–æ–¥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫–∞
    const messagesWithSender = await Promise.all(
      messages.map(async (message) => {
        const sender = await ctx.db.get(message.senderId);
        return {
          ...message,
          sender: sender
            ? {
                _id: sender._id,
                username: sender.username,
                image: sender.image,
              }
            : null,
          isOwn: message.senderId === userId,
        };
      })
    );

    return messagesWithSender;
  },
});

// –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ç–µ–∫—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
export const sendMessage = mutation({
  args: {
    conversationId: v.id('conversations'),
    content: v.string(),
  },
  handler: async (ctx, args) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) throw new Error('Not authenticated');

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –¥—ñ–∞–ª–æ–≥—É
    const conversation = await ctx.db.get(args.conversationId);
    if (!conversation) throw new Error('Conversation not found');

    if (conversation.participantOneId !== userId && conversation.participantTwoId !== userId) {
      throw new Error('Access denied');
    }

    // –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    const messageId = await ctx.db.insert('messages', {
      conversationId: args.conversationId,
      senderId: userId,
      content: args.content,
      isRead: false,
    });

    // –û–Ω–æ–≤–ª—é—î–º–æ –¥—ñ–∞–ª–æ–≥
    await ctx.db.patch(args.conversationId, {
      lastMessageId: messageId,
      lastMessageTime: Date.now(),
    });

    return messageId;
  },
});

// –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
export const sendImageMessage = mutation({
  args: {
    conversationId: v.id('conversations'),
    storageId: v.id('_storage'),
    imageUrl: v.string(),
  },
  handler: async (ctx, args) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) throw new Error('Not authenticated');

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –¥—ñ–∞–ª–æ–≥—É
    const conversation = await ctx.db.get(args.conversationId);
    if (!conversation) throw new Error('Conversation not found');

    if (conversation.participantOneId !== userId && conversation.participantTwoId !== userId) {
      throw new Error('Access denied');
    }

    // –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º
    const messageId = await ctx.db.insert('messages', {
      conversationId: args.conversationId,
      senderId: userId,
      imageUrl: args.imageUrl,
      storageId: args.storageId,
      isRead: false,
    });

    // –û–Ω–æ–≤–ª—é—î–º–æ –¥—ñ–∞–ª–æ–≥
    await ctx.db.patch(args.conversationId, {
      lastMessageId: messageId,
      lastMessageTime: Date.now(),
    });

    return messageId;
  },
});

// –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —è–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω—ñ
export const markAsRead = mutation({
  args: { conversationId: v.id('conversations') },
  handler: async (ctx, args) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) throw new Error('Not authenticated');

    const unreadMessages = await ctx.db
      .query('messages')
      .withIndex('by_conversation', (q) => q.eq('conversationId', args.conversationId))
      .filter((q) => q.and(q.eq(q.field('isRead'), false), q.neq(q.field('senderId'), userId)))
      .collect();

    await Promise.all(unreadMessages.map((message) => ctx.db.patch(message._id, { isRead: true })));

    return unreadMessages.length;
  },
});

// –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è URL –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
export const generateUploadUrl = mutation({
  args: {},
  handler: async (ctx) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) throw new Error('Not authenticated');

    return await ctx.storage.generateUploadUrl();
  },
});
```

---

## 4. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ UI

### –ö—Ä–æ–∫ 4.1: –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `components/ConversationItem.tsx`

```tsx
// components/ConversationItem.tsx

import { View, Text, TouchableOpacity, StyleSheet } from 'react-native';
import { Image } from 'expo-image';
import { formatDistanceToNow } from 'date-fns';
import { uk } from 'date-fns/locale';
import { COLORS } from '@/constants/theme';
import { Id } from '@/convex/_generated/dataModel';

interface ConversationItemProps {
  conversation: {
    _id: Id<'conversations'>;
    otherUser: {
      _id: Id<'users'>;
      username: string;
      fullname: string;
      image: string;
    } | null;
    lastMessage: {
      content?: string;
      imageUrl?: string;
      senderId: Id<'users'>;
      _creationTime: number;
    } | null;
    unreadCount: number;
    lastMessageTime?: number;
    _creationTime: number;
  };
  onPress: () => void;
}

export const ConversationItem = ({ conversation, onPress }: ConversationItemProps) => {
  const { otherUser, lastMessage, unreadCount } = conversation;

  if (!otherUser) return null;

  const getLastMessagePreview = () => {
    if (!lastMessage) return '–ü–æ—á–Ω—ñ—Ç—å —Ä–æ–∑–º–æ–≤—É';
    if (lastMessage.imageUrl) return 'üì∑ –§–æ—Ç–æ';
    return lastMessage.content || '';
  };

  const getTime = () => {
    const time = conversation.lastMessageTime || conversation._creationTime;
    return formatDistanceToNow(time, { addSuffix: true, locale: uk });
  };

  return (
    <TouchableOpacity style={styles.container} onPress={onPress}>
      <Image source={otherUser.image} style={styles.avatar} contentFit="cover" transition={200} />

      <View style={styles.content}>
        <View style={styles.header}>
          <Text style={styles.username} numberOfLines={1}>
            {otherUser.username}
          </Text>
          <Text style={styles.time}>{getTime()}</Text>
        </View>

        <View style={styles.messageRow}>
          <Text
            style={[styles.lastMessage, unreadCount > 0 && styles.unreadMessage]}
            numberOfLines={1}
          >
            {getLastMessagePreview()}
          </Text>

          {unreadCount > 0 && (
            <View style={styles.badge}>
              <Text style={styles.badgeText}>{unreadCount > 99 ? '99+' : unreadCount}</Text>
            </View>
          )}
        </View>
      </View>
    </TouchableOpacity>
  );
};

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 16,
    backgroundColor: COLORS.background,
    borderBottomWidth: 0.5,
    borderBottomColor: COLORS.grey,
  },
  avatar: {
    width: 56,
    height: 56,
    borderRadius: 28,
    marginRight: 12,
  },
  content: {
    flex: 1,
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 4,
  },
  username: {
    fontSize: 16,
    fontWeight: '600',
    color: COLORS.white,
    flex: 1,
    marginRight: 8,
  },
  time: {
    fontSize: 12,
    color: COLORS.grey,
  },
  messageRow: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
  },
  lastMessage: {
    fontSize: 14,
    color: COLORS.grey,
    flex: 1,
    marginRight: 8,
  },
  unreadMessage: {
    color: COLORS.white,
    fontWeight: '500',
  },
  badge: {
    backgroundColor: COLORS.primary,
    borderRadius: 12,
    minWidth: 24,
    height: 24,
    justifyContent: 'center',
    alignItems: 'center',
    paddingHorizontal: 8,
  },
  badgeText: {
    color: COLORS.white,
    fontSize: 12,
    fontWeight: '600',
  },
});
```

### –ö—Ä–æ–∫ 4.2: –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `components/MessageBubble.tsx`

```tsx
// components/MessageBubble.tsx

import { View, Text, StyleSheet, Dimensions } from 'react-native';
import { Image } from 'expo-image';
import { format } from 'date-fns';
import { COLORS } from '@/constants/theme';
import { Id } from '@/convex/_generated/dataModel';

const { width: SCREEN_WIDTH } = Dimensions.get('window');
const MAX_BUBBLE_WIDTH = SCREEN_WIDTH * 0.75;

interface MessageBubbleProps {
  message: {
    _id: Id<'messages'>;
    content?: string;
    imageUrl?: string;
    isOwn: boolean;
    isRead: boolean;
    _creationTime: number;
    sender: {
      _id: Id<'users'>;
      username: string;
      image: string;
    } | null;
  };
}

export const MessageBubble = ({ message }: MessageBubbleProps) => {
  const { isOwn, content, imageUrl, _creationTime, isRead } = message;

  return (
    <View style={[styles.container, isOwn ? styles.ownContainer : styles.otherContainer]}>
      {!isOwn && message.sender && (
        <Image source={message.sender.image} style={styles.avatar} contentFit="cover" />
      )}

      <View style={[styles.bubble, isOwn ? styles.ownBubble : styles.otherBubble]}>
        {imageUrl && (
          <Image source={imageUrl} style={styles.image} contentFit="cover" transition={200} />
        )}

        {content && (
          <Text style={[styles.text, isOwn ? styles.ownText : styles.otherText]}>{content}</Text>
        )}

        <View style={styles.footer}>
          <Text style={[styles.time, isOwn ? styles.ownTime : styles.otherTime]}>
            {format(_creationTime, 'HH:mm')}
          </Text>
          {isOwn && <Text style={styles.readStatus}>{isRead ? '‚úì‚úì' : '‚úì'}</Text>}
        </View>
      </View>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    marginVertical: 4,
    paddingHorizontal: 12,
  },
  ownContainer: {
    justifyContent: 'flex-end',
  },
  otherContainer: {
    justifyContent: 'flex-start',
  },
  avatar: {
    width: 32,
    height: 32,
    borderRadius: 16,
    marginRight: 8,
  },
  bubble: {
    maxWidth: MAX_BUBBLE_WIDTH,
    borderRadius: 16,
    padding: 12,
  },
  ownBubble: {
    backgroundColor: COLORS.primary,
    borderBottomRightRadius: 4,
  },
  otherBubble: {
    backgroundColor: COLORS.grey,
    borderBottomLeftRadius: 4,
  },
  image: {
    width: MAX_BUBBLE_WIDTH - 24,
    height: 200,
    borderRadius: 8,
    marginBottom: 8,
  },
  text: {
    fontSize: 16,
    lineHeight: 22,
  },
  ownText: {
    color: COLORS.white,
  },
  otherText: {
    color: COLORS.white,
  },
  footer: {
    flexDirection: 'row',
    justifyContent: 'flex-end',
    alignItems: 'center',
    marginTop: 4,
  },
  time: {
    fontSize: 11,
  },
  ownTime: {
    color: 'rgba(255, 255, 255, 0.7)',
  },
  otherTime: {
    color: 'rgba(255, 255, 255, 0.5)',
  },
  readStatus: {
    fontSize: 11,
    color: 'rgba(255, 255, 255, 0.7)',
    marginLeft: 4,
  },
});
```

### –ö—Ä–æ–∫ 4.3: –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `components/ChatInput.tsx`

```tsx
// components/ChatInput.tsx

import { useState } from 'react';
import { View, TextInput, TouchableOpacity, StyleSheet, ActivityIndicator } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import * as ImagePicker from 'expo-image-picker';
import { COLORS } from '@/constants/theme';

interface ChatInputProps {
  onSendText: (text: string) => Promise<void>;
  onSendImage: (uri: string) => Promise<void>;
  disabled?: boolean;
}

export const ChatInput = ({ onSendText, onSendImage, disabled }: ChatInputProps) => {
  const [text, setText] = useState('');
  const [isSending, setIsSending] = useState(false);

  const handleSendText = async () => {
    if (!text.trim() || isSending) return;

    setIsSending(true);
    try {
      await onSendText(text.trim());
      setText('');
    } catch (error) {
      console.error('Error sending message:', error);
    } finally {
      setIsSending(false);
    }
  };

  const handlePickImage = async () => {
    if (isSending) return;

    const result = await ImagePicker.launchImageLibraryAsync({
      mediaTypes: ImagePicker.MediaTypeOptions.Images,
      allowsEditing: true,
      quality: 0.8,
    });

    if (!result.canceled && result.assets[0]) {
      setIsSending(true);
      try {
        await onSendImage(result.assets[0].uri);
      } catch (error) {
        console.error('Error sending image:', error);
      } finally {
        setIsSending(false);
      }
    }
  };

  return (
    <View style={styles.container}>
      <TouchableOpacity
        style={styles.iconButton}
        onPress={handlePickImage}
        disabled={disabled || isSending}
      >
        <Ionicons name="image-outline" size={24} color={COLORS.primary} />
      </TouchableOpacity>

      <TextInput
        style={styles.input}
        value={text}
        onChangeText={setText}
        placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."
        placeholderTextColor={COLORS.grey}
        multiline
        maxLength={1000}
        editable={!disabled && !isSending}
      />

      <TouchableOpacity
        style={[styles.sendButton, (!text.trim() || isSending) && styles.sendButtonDisabled]}
        onPress={handleSendText}
        disabled={!text.trim() || disabled || isSending}
      >
        {isSending ? (
          <ActivityIndicator size="small" color={COLORS.white} />
        ) : (
          <Ionicons name="send" size={20} color={COLORS.white} />
        )}
      </TouchableOpacity>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    alignItems: 'flex-end',
    padding: 8,
    backgroundColor: COLORS.background,
    borderTopWidth: 0.5,
    borderTopColor: COLORS.grey,
  },
  iconButton: {
    padding: 8,
    marginRight: 4,
  },
  input: {
    flex: 1,
    backgroundColor: '#2a2a2a',
    borderRadius: 20,
    paddingHorizontal: 16,
    paddingVertical: 10,
    fontSize: 16,
    color: COLORS.white,
    maxHeight: 100,
  },
  sendButton: {
    backgroundColor: COLORS.primary,
    width: 40,
    height: 40,
    borderRadius: 20,
    justifyContent: 'center',
    alignItems: 'center',
    marginLeft: 8,
  },
  sendButtonDisabled: {
    opacity: 0.5,
  },
});
```

---

## 5. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –µ–∫—Ä–∞–Ω—ñ–≤

### –ö—Ä–æ–∫ 5.1: –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `app/(tabs)/messages.tsx`

```tsx
// app/(tabs)/messages.tsx

import { View, Text, FlatList, StyleSheet, TouchableOpacity } from 'react-native';
import { useRouter } from 'expo-router';
import { useQuery } from 'convex/react';
import { api } from '@/convex/_generated/api';
import { ConversationItem } from '@/components/ConversationItem';
import { Loader } from '@/components/Loader';
import { COLORS } from '@/constants/theme';
import { Ionicons } from '@expo/vector-icons';

export default function MessagesScreen() {
  const router = useRouter();
  const conversations = useQuery(api.conversations.getConversations);

  if (conversations === undefined) {
    return <Loader />;
  }

  const handleConversationPress = (conversationId: string) => {
    router.push(`/chat/${conversationId}`);
  };

  const handleNewMessage = () => {
    // –ú–æ–∂–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –≤–∏–±–æ—Ä—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    // –∞–±–æ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –µ–∫—Ä–∞–Ω –ø–æ—à—É–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
    router.push('/new-chat');
  };

  return (
    <View style={styles.container}>
      <View style={styles.header}>
        <Text style={styles.title}>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</Text>
        <TouchableOpacity onPress={handleNewMessage}>
          <Ionicons name="create-outline" size={24} color={COLORS.primary} />
        </TouchableOpacity>
      </View>

      {conversations.length === 0 ? (
        <View style={styles.emptyContainer}>
          <Ionicons name="chatbubbles-outline" size={64} color={COLORS.grey} />
          <Text style={styles.emptyText}>–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</Text>
          <Text style={styles.emptySubtext}>–ü–æ—á–Ω—ñ—Ç—å —Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è –∑ –¥—Ä—É–∑—è–º–∏</Text>
        </View>
      ) : (
        <FlatList
          data={conversations}
          keyExtractor={(item) => item._id}
          renderItem={({ item }) => (
            <ConversationItem
              conversation={item}
              onPress={() => handleConversationPress(item._id)}
            />
          )}
          showsVerticalScrollIndicator={false}
        />
      )}
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: COLORS.background,
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 0.5,
    borderBottomColor: COLORS.grey,
  },
  title: {
    fontSize: 24,
    fontWeight: 'bold',
    color: COLORS.white,
  },
  emptyContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 32,
  },
  emptyText: {
    fontSize: 18,
    fontWeight: '600',
    color: COLORS.white,
    marginTop: 16,
  },
  emptySubtext: {
    fontSize: 14,
    color: COLORS.grey,
    marginTop: 8,
    textAlign: 'center',
  },
});
```

### –ö—Ä–æ–∫ 5.2: –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `app/chat/[id].tsx`

```tsx
// app/chat/[id].tsx

import { useEffect, useRef } from 'react';
import {
  View,
  FlatList,
  StyleSheet,
  KeyboardAvoidingView,
  Platform,
  TouchableOpacity,
  Text,
} from 'react-native';
import { useLocalSearchParams, useRouter } from 'expo-router';
import { useQuery, useMutation } from 'convex/react';
import { api } from '@/convex/_generated/api';
import { Id } from '@/convex/_generated/dataModel';
import { MessageBubble } from '@/components/MessageBubble';
import { ChatInput } from '@/components/ChatInput';
import { Loader } from '@/components/Loader';
import { COLORS } from '@/constants/theme';
import { Ionicons } from '@expo/vector-icons';
import { Image } from 'expo-image';
import * as FileSystem from 'expo-file-system';

export default function ChatScreen() {
  const { id } = useLocalSearchParams<{ id: string }>();
  const router = useRouter();
  const flatListRef = useRef<FlatList>(null);

  const conversationId = id as Id<'conversations'>;

  const conversation = useQuery(api.conversations.getConversation, {
    conversationId,
  });
  const messages = useQuery(api.messages.getMessages, { conversationId });

  const sendMessage = useMutation(api.messages.sendMessage);
  const sendImageMessage = useMutation(api.messages.sendImageMessage);
  const generateUploadUrl = useMutation(api.messages.generateUploadUrl);
  const markAsRead = useMutation(api.messages.markAsRead);

  // –ü–æ–∑–Ω–∞—á–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —è–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω—ñ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —á–∞—Ç—É
  useEffect(() => {
    if (conversationId) {
      markAsRead({ conversationId });
    }
  }, [conversationId, messages]);

  // –ü—Ä–æ–∫—Ä—É—á—É—î–º–æ –¥–æ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
  useEffect(() => {
    if (messages && messages.length > 0) {
      setTimeout(() => {
        flatListRef.current?.scrollToEnd({ animated: true });
      }, 100);
    }
  }, [messages]);

  const handleSendText = async (text: string) => {
    await sendMessage({
      conversationId,
      content: text,
    });
  };

  const handleSendImage = async (uri: string) => {
    try {
      // –û—Ç—Ä–∏–º—É—î–º–æ URL –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
      const uploadUrl = await generateUploadUrl();

      // –ß–∏—Ç–∞—î–º–æ —Ñ–∞–π–ª
      const response = await fetch(uri);
      const blob = await response.blob();

      // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      const uploadResponse = await fetch(uploadUrl, {
        method: 'POST',
        headers: { 'Content-Type': blob.type },
        body: blob,
      });

      const { storageId } = await uploadResponse.json();

      // –û—Ç—Ä–∏–º—É—î–º–æ URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
      const imageUrl = `${process.env.EXPO_PUBLIC_CONVEX_URL}/api/storage/${storageId}`;

      // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º
      await sendImageMessage({
        conversationId,
        storageId,
        imageUrl,
      });
    } catch (error) {
      console.error('Error uploading image:', error);
    }
  };

  if (conversation === undefined || messages === undefined) {
    return <Loader />;
  }

  if (!conversation) {
    return (
      <View style={styles.errorContainer}>
        <Text style={styles.errorText}>–î—ñ–∞–ª–æ–≥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</Text>
      </View>
    );
  }

  return (
    <KeyboardAvoidingView
      style={styles.container}
      behavior={Platform.OS === 'ios' ? 'padding' : undefined}
      keyboardVerticalOffset={90}
    >
      {/* Header */}
      <View style={styles.header}>
        <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>
          <Ionicons name="arrow-back" size={24} color={COLORS.white} />
        </TouchableOpacity>

        {conversation.otherUser && (
          <TouchableOpacity
            style={styles.userInfo}
            onPress={() => router.push(`/user/${conversation.otherUser?._id}`)}
          >
            <Image source={conversation.otherUser.image} style={styles.avatar} contentFit="cover" />
            <View>
              <Text style={styles.username}>{conversation.otherUser.username}</Text>
              <Text style={styles.fullname}>{conversation.otherUser.fullname}</Text>
            </View>
          </TouchableOpacity>
        )}
      </View>

      {/* Messages */}
      <FlatList
        ref={flatListRef}
        data={messages}
        keyExtractor={(item) => item._id}
        renderItem={({ item }) => <MessageBubble message={item} />}
        contentContainerStyle={styles.messagesList}
        showsVerticalScrollIndicator={false}
        onContentSizeChange={() => flatListRef.current?.scrollToEnd({ animated: false })}
      />

      {/* Input */}
      <ChatInput onSendText={handleSendText} onSendImage={handleSendImage} />
    </KeyboardAvoidingView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: COLORS.background,
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 12,
    borderBottomWidth: 0.5,
    borderBottomColor: COLORS.grey,
    paddingTop: 50, // –î–ª—è safe area
  },
  backButton: {
    padding: 8,
    marginRight: 8,
  },
  userInfo: {
    flexDirection: 'row',
    alignItems: 'center',
    flex: 1,
  },
  avatar: {
    width: 40,
    height: 40,
    borderRadius: 20,
    marginRight: 12,
  },
  username: {
    fontSize: 16,
    fontWeight: '600',
    color: COLORS.white,
  },
  fullname: {
    fontSize: 12,
    color: COLORS.grey,
  },
  messagesList: {
    paddingVertical: 16,
  },
  errorContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: COLORS.background,
  },
  errorText: {
    color: COLORS.white,
    fontSize: 16,
  },
});
```

### –ö—Ä–æ–∫ 5.3: –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `app/new-chat.tsx` (–≤–∏–±—ñ—Ä –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç—É)

```tsx
// app/new-chat.tsx

import { useState } from 'react';
import { View, Text, TextInput, FlatList, TouchableOpacity, StyleSheet } from 'react-native';
import { useRouter } from 'expo-router';
import { useQuery, useMutation } from 'convex/react';
import { api } from '@/convex/_generated/api';
import { Image } from 'expo-image';
import { COLORS } from '@/constants/theme';
import { Ionicons } from '@expo/vector-icons';
import { Id } from '@/convex/_generated/dataModel';

export default function NewChatScreen() {
  const router = useRouter();
  const [searchQuery, setSearchQuery] = useState('');

  // –û—Ç—Ä–∏–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, –Ω–∞ —è–∫–∏—Ö –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
  const following = useQuery(api.users.getFollowing);
  const getOrCreateConversation = useMutation(api.conversations.getOrCreateConversation);

  const filteredUsers = following?.filter(
    (user) =>
      user.username.toLowerCase().includes(searchQuery.toLowerCase()) ||
      user.fullname.toLowerCase().includes(searchQuery.toLowerCase())
  );

  const handleSelectUser = async (userId: Id<'users'>) => {
    try {
      const conversationId = await getOrCreateConversation({
        otherUserId: userId,
      });
      router.replace(`/chat/${conversationId}`);
    } catch (error) {
      console.error('Error creating conversation:', error);
    }
  };

  return (
    <View style={styles.container}>
      <View style={styles.header}>
        <TouchableOpacity onPress={() => router.back()}>
          <Ionicons name="close" size={24} color={COLORS.white} />
        </TouchableOpacity>
        <Text style={styles.title}>–ù–æ–≤–∏–π —á–∞—Ç</Text>
        <View style={{ width: 24 }} />
      </View>

      <View style={styles.searchContainer}>
        <Ionicons name="search" size={20} color={COLORS.grey} />
        <TextInput
          style={styles.searchInput}
          placeholder="–ü–æ—à—É–∫..."
          placeholderTextColor={COLORS.grey}
          value={searchQuery}
          onChangeText={setSearchQuery}
        />
      </View>

      <FlatList
        data={filteredUsers}
        keyExtractor={(item) => item._id}
        renderItem={({ item }) => (
          <TouchableOpacity style={styles.userItem} onPress={() => handleSelectUser(item._id)}>
            <Image source={item.image} style={styles.avatar} contentFit="cover" />
            <View style={styles.userInfo}>
              <Text style={styles.username}>{item.username}</Text>
              <Text style={styles.fullname}>{item.fullname}</Text>
            </View>
          </TouchableOpacity>
        )}
        ListEmptyComponent={
          <View style={styles.emptyContainer}>
            <Text style={styles.emptyText}>
              {searchQuery
                ? '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'
                : '–ü—ñ–¥–ø–∏—à—ñ—Ç—å—Å—è –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, —â–æ–± –ø–æ—á–∞—Ç–∏ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è'}
            </Text>
          </View>
        }
      />
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: COLORS.background,
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 16,
    paddingTop: 50,
    borderBottomWidth: 0.5,
    borderBottomColor: COLORS.grey,
  },
  title: {
    fontSize: 18,
    fontWeight: '600',
    color: COLORS.white,
  },
  searchContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#2a2a2a',
    margin: 16,
    paddingHorizontal: 12,
    borderRadius: 10,
  },
  searchInput: {
    flex: 1,
    paddingVertical: 12,
    paddingHorizontal: 8,
    fontSize: 16,
    color: COLORS.white,
  },
  userItem: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 0.5,
    borderBottomColor: COLORS.grey,
  },
  avatar: {
    width: 50,
    height: 50,
    borderRadius: 25,
    marginRight: 12,
  },
  userInfo: {
    flex: 1,
  },
  username: {
    fontSize: 16,
    fontWeight: '600',
    color: COLORS.white,
  },
  fullname: {
    fontSize: 14,
    color: COLORS.grey,
    marginTop: 2,
  },
  emptyContainer: {
    padding: 32,
    alignItems: 'center',
  },
  emptyText: {
    color: COLORS.grey,
    textAlign: 'center',
  },
});
```

---

## 6. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó

### –ö—Ä–æ–∫ 6.1: –û–Ω–æ–≤—ñ—Ç—å —Ñ–∞–π–ª `app/(tabs)/_layout.tsx`

–î–æ–¥–∞–π—Ç–µ –Ω–æ–≤–∏–π —Ç–∞–± –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:

```tsx
// app/(tabs)/_layout.tsx

import { Tabs } from 'expo-router';
import { Ionicons } from '@expo/vector-icons';
import { COLORS } from '@/constants/theme';
import { useQuery } from 'convex/react';
import { api } from '@/convex/_generated/api';

export default function TabLayout() {
  // –û—Ç—Ä–∏–º—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –¥–ª—è badge
  const conversations = useQuery(api.conversations.getConversations);
  const unreadCount = conversations?.reduce((sum, conv) => sum + conv.unreadCount, 0) || 0;

  return (
    <Tabs
      screenOptions={{
        tabBarActiveTintColor: COLORS.primary,
        tabBarInactiveTintColor: COLORS.grey,
        tabBarStyle: {
          backgroundColor: COLORS.background,
          borderTopColor: COLORS.grey,
        },
        headerShown: false,
      }}
    >
      <Tabs.Screen
        name="index"
        options={{
          title: '–ì–æ–ª–æ–≤–Ω–∞',
          tabBarIcon: ({ color, size }) => <Ionicons name="home" size={size} color={color} />,
        }}
      />
      <Tabs.Screen
        name="messages"
        options={{
          title: '–ß–∞—Ç–∏',
          tabBarIcon: ({ color, size }) => (
            <Ionicons name="chatbubbles" size={size} color={color} />
          ),
          tabBarBadge: unreadCount > 0 ? unreadCount : undefined,
          tabBarBadgeStyle: {
            backgroundColor: COLORS.primary,
          },
        }}
      />
      <Tabs.Screen
        name="create"
        options={{
          title: '–°—Ç–≤–æ—Ä–∏—Ç–∏',
          tabBarIcon: ({ color, size }) => <Ionicons name="add-circle" size={size} color={color} />,
        }}
      />
      <Tabs.Screen
        name="notifications"
        options={{
          title: '–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è',
          tabBarIcon: ({ color, size }) => (
            <Ionicons name="notifications" size={size} color={color} />
          ),
        }}
      />
      <Tabs.Screen
        name="profile"
        options={{
          title: '–ü—Ä–æ—Ñ—ñ–ª—å',
          tabBarIcon: ({ color, size }) => <Ionicons name="person" size={size} color={color} />,
        }}
      />
      {/* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ bookmarks –∑ —Ç–∞–±—ñ–≤, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ */}
      <Tabs.Screen
        name="bookmarks"
        options={{
          href: null, // –ü—Ä–∏—Ö–æ–≤—É—î –∑ —Ç–∞–±—ñ–≤
        }}
      />
    </Tabs>
  );
}
```

### –ö—Ä–æ–∫ 6.2: –û–Ω–æ–≤—ñ—Ç—å —Ñ–∞–π–ª `app/_layout.tsx`

–î–æ–¥–∞–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç–∏ –¥–ª—è —á–∞—Ç—É:

```tsx
// app/_layout.tsx

import { Stack } from 'expo-router';
import { ClerkAndConvexProvider } from '@/providers/ClerkAndConvexProvider';
import { InitialLayout } from '@/components/InitialLayout';

export default function RootLayout() {
  return (
    <ClerkAndConvexProvider>
      <InitialLayout>
        <Stack screenOptions={{ headerShown: false }}>
          <Stack.Screen name="(tabs)" />
          <Stack.Screen name="(auth)" />
          <Stack.Screen name="user/[id]" />
          <Stack.Screen name="chat/[id]" />
          <Stack.Screen
            name="new-chat"
            options={{
              presentation: 'modal',
            }}
          />
        </Stack>
      </InitialLayout>
    </ClerkAndConvexProvider>
  );
}
```

---

## 7. –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è

### 7.1: –î–æ–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü—ñ—é `getFollowing` –≤ `convex/users.ts`

```typescript
// –î–æ–¥–∞–π—Ç–µ –≤ convex/users.ts

export const getFollowing = query({
  args: {},
  handler: async (ctx) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) return [];

    const follows = await ctx.db
      .query('follows')
      .withIndex('by_follower', (q) => q.eq('followerId', userId))
      .collect();

    const users = await Promise.all(
      follows.map(async (follow) => {
        const user = await ctx.db.get(follow.followingId);
        return user;
      })
    );

    return users.filter(Boolean);
  },
});
```

### 7.2: –ö–Ω–æ–ø–∫–∞ "–ù–∞–ø–∏—Å–∞—Ç–∏" –Ω–∞ –ø—Ä–æ—Ñ—ñ–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

–î–æ–¥–∞–π—Ç–µ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—Ä–æ—Ñ—ñ–ª—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ—á–∞—Ç–∫—É —á–∞—Ç—É:

```tsx
// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ –ø—Ä–æ—Ñ—ñ–ª—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

const handleMessage = async () => {
  const conversationId = await getOrCreateConversation({ otherUserId: userId });
  router.push(`/chat/${conversationId}`);
};

// –í JSX:
<TouchableOpacity style={styles.messageButton} onPress={handleMessage}>
  <Ionicons name="chatbubble-outline" size={20} color={COLORS.white} />
  <Text style={styles.messageButtonText}>–ù–∞–ø–∏—Å–∞—Ç–∏</Text>
</TouchableOpacity>;
```

---

## –ß–µ–∫-–ª–∏—Å—Ç –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è

- [ ] –û–Ω–æ–≤–∏—Ç–∏ `convex/schema.ts` (–¥–æ–¥–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—ñ `conversations` —Ç–∞ `messages`)
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `convex/conversations.ts`
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `convex/messages.ts`
- [ ] –î–æ–¥–∞—Ç–∏ `getFollowing` –≤ `convex/users.ts`
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `components/ConversationItem.tsx`
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `components/MessageBubble.tsx`
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `components/ChatInput.tsx`
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `app/(tabs)/messages.tsx`
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `app/chat/[id].tsx`
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `app/new-chat.tsx`
- [ ] –û–Ω–æ–≤–∏—Ç–∏ `app/(tabs)/_layout.tsx`
- [ ] –û–Ω–æ–≤–∏—Ç–∏ `app/_layout.tsx`
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç–∏ `npx convex dev` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó —Å—Ö–µ–º–∏
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª

---

## –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏ —Ç–∞ —Ä—ñ—à–µ–Ω–Ω—è

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–µ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ

**–†—ñ—à–µ–Ω–Ω—è:** Convex –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î —Ä–µ–∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ `useQuery` –∑–∞–º—ñ—Å—Ç—å `useMutation` –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö.

### –ü—Ä–æ–±–ª–µ–º–∞: –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è

**–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π `EXPO_PUBLIC_CONVEX_URL` –≤ `.env.local`.

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó

**–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ `getAuthUserId` –ø—Ä–∞–≤–∏–ª—å–Ω–æ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–∏–π —Ç–∞ Clerk –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π.

---

## –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

–ü—ñ—Å–ª—è –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è –±–∞–∑–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏:

1. **Push-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è** –ø—Ä–æ –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
2. **Typing indicator** (—ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä—É —Ç–µ–∫—Å—Ç—É)
3. **–í–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å**
4. **–ì—Ä—É–ø–æ–≤—ñ —á–∞—Ç–∏**
5. **–ì–æ–ª–æ—Å–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è**
6. **–†–µ–∞–∫—Ü—ñ—ó –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è**

---
