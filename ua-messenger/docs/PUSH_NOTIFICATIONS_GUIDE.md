# –ì–∞–π–¥: Push-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∑ expo-notifications

–¶–µ–π –≥–∞–π–¥ –æ–ø–∏—Å—É—î –¥–æ–¥–∞–≤–∞–Ω–Ω—è push-—Å–ø–æ–≤—ñ—â–µ–Ω—å –¥–ª—è –ª–∞–π–∫—ñ–≤, –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ —Ç–∞ –ø—ñ–¥–ø–∏—Å–æ–∫ —É –¥–æ–¥–∞—Ç–æ–∫ **ua-messenger**.

---

## –ó–º—ñ—Å—Ç

1. [–û–≥–ª—è–¥ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏](#1-–æ–≥–ª—è–¥-–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏)
2. [–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π](#2-–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è-–∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π)
3. [–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Expo](#3-–Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è-expo)
4. [–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ö–µ–º–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö](#4-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è-—Å—Ö–µ–º–∏-–±–∞–∑–∏-–¥–∞–Ω–∏—Ö)
5. [–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–µ—Ä–≤—ñ—Å—É —Å–ø–æ–≤—ñ—â–µ–Ω—å](#5-—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è-—Å–µ—Ä–≤—ñ—Å—É-—Å–ø–æ–≤—ñ—â–µ–Ω—å)
6. [–û–Ω–æ–≤–ª–µ–Ω–Ω—è Convex —Ñ—É–Ω–∫—Ü—ñ–π](#6-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è-convex-—Ñ—É–Ω–∫—Ü—ñ–π)
7. [–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –≤ –¥–æ–¥–∞—Ç–æ–∫](#7-—ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è-–≤-–¥–æ–¥–∞—Ç–æ–∫)
8. [–û–±—Ä–æ–±–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω—å](#8-–æ–±—Ä–æ–±–∫–∞-—Å–ø–æ–≤—ñ—â–µ–Ω—å)
9. [–ß–µ–∫-–ª–∏—Å—Ç –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è](#9-—á–µ–∫-–ª–∏—Å—Ç-–≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è)

---

## 1. –û–≥–ª—è–¥ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏

### –ü–æ—Ç—ñ–∫ push-—Å–ø–æ–≤—ñ—â–µ–Ω—å:

```
1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ä–µ—î—Å—Ç—Ä—É—î—Ç—å—Å—è ‚Üí –û—Ç—Ä–∏–º—É—î Expo Push Token
2. Token –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –ë–î (—Ç–∞–±–ª–∏—Ü—è users)
3. –î—ñ—è (–ª–∞–π–∫/–∫–æ–º–µ–Ω—Ç–∞—Ä/–ø—ñ–¥–ø–∏—Å–∫–∞) ‚Üí Convex mutation
4. Mutation –≤–∏–∫–ª–∏–∫–∞—î HTTP action –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ push
5. Expo Push Service –¥–æ—Å—Ç–∞–≤–ª—è—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
6. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ—Ç—Ä–∏–º—É—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –Ω–∞ –ø—Ä–∏—Å—Ç—Ä—ñ–π
```

### –ù–æ–≤—ñ/–æ–Ω–æ–≤–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏:

```
hooks/
‚îî‚îÄ‚îÄ usePushNotifications.ts   # –•—É–∫ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Ç–∞ –æ–±—Ä–æ–±–∫–∏

convex/
‚îú‚îÄ‚îÄ pushNotifications.ts      # HTTP actions –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
‚îî‚îÄ‚îÄ users.ts                  # –û–Ω–æ–≤–ª–µ–Ω–Ω—è (–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è token)

providers/
‚îî‚îÄ‚îÄ NotificationProvider.tsx  # –ü—Ä–æ–≤–∞–π–¥–µ—Ä —Å–ø–æ–≤—ñ—â–µ–Ω—å

app/
‚îî‚îÄ‚îÄ _layout.tsx               # –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
```

---

## 2. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π

```bash
npx expo install expo-notifications expo-device expo-constants
```

---

## 3. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Expo

### –ö—Ä–æ–∫ 3.1: –û–Ω–æ–≤—ñ—Ç—å `app.config.ts`

```typescript
// app.config.ts

export default {
  expo: {
    // ... —ñ—Å–Ω—É—é—á—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

    plugins: [
      // ... —ñ–Ω—à—ñ –ø–ª–∞–≥—ñ–Ω–∏
      [
        'expo-notifications',
        {
          icon: './assets/images/notification-icon.png', // 96x96 PNG
          color: '#ffffff',
          sounds: ['./assets/sounds/notification.wav'], // –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ
        },
      ],
    ],

    // –î–ª—è Android
    android: {
      // ... —ñ—Å–Ω—É—é—á—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
      googleServicesFile: './google-services.json', // –¥–ª—è FCM
      permissions: ['RECEIVE_BOOT_COMPLETED', 'VIBRATE'],
    },

    // –î–ª—è iOS
    ios: {
      // ... —ñ—Å–Ω—É—é—á—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
      infoPlist: {
        UIBackgroundModes: ['remote-notification'],
      },
    },

    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å
    notification: {
      icon: './assets/images/notification-icon.png',
      color: '#3b82f6',
      androidMode: 'default',
      androidCollapsedTitle: 'ua-messenger',
    },
  },
};
```

### –ö—Ä–æ–∫ 3.2: –°—Ç–≤–æ—Ä—ñ—Ç—å —ñ–∫–æ–Ω–∫—É —Å–ø–æ–≤—ñ—â–µ–Ω—å

–°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `assets/images/notification-icon.png` —Ä–æ–∑–º—ñ—Ä–æ–º 96x96 –ø—ñ–∫—Å–µ–ª—ñ–≤ (–º–æ–Ω–æ—Ö—Ä–æ–º–Ω–∏–π PNG –¥–ª—è Android).

---

## 4. –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ö–µ–º–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

### –û–Ω–æ–≤—ñ—Ç—å `convex/schema.ts`

–î–æ–¥–∞–π—Ç–µ –ø–æ–ª–µ `pushToken` –¥–æ —Ç–∞–±–ª–∏—Ü—ñ `users`:

```typescript
// convex/schema.ts

users: defineTable({
  username: v.string(),
  fullname: v.string(),
  email: v.string(),
  bio: v.optional(v.string()),
  image: v.string(),
  followers: v.number(),
  following: v.number(),
  posts: v.number(),
  clerkId: v.string(),
  pushToken: v.optional(v.string()),  // –î–æ–¥–∞—Ç–∏ —Ü–µ –ø–æ–ª–µ
  notificationsEnabled: v.optional(v.boolean()), // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å
}).index('by_clerk_id', ['clerkId']),
```

---

## 5. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–µ—Ä–≤—ñ—Å—É —Å–ø–æ–≤—ñ—â–µ–Ω—å

### –ö—Ä–æ–∫ 5.1: –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `hooks/usePushNotifications.ts`

```typescript
// hooks/usePushNotifications.ts

import { useState, useEffect, useRef } from 'react';
import { Platform } from 'react-native';
import * as Device from 'expo-device';
import * as Notifications from 'expo-notifications';
import Constants from 'expo-constants';
import { useRouter } from 'expo-router';
import { useMutation } from 'convex/react';
import { api } from '@/convex/_generated/api';

// –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–æ–≤–µ–¥—ñ–Ω–∫–∏ —Å–ø–æ–≤—ñ—â–µ–Ω—å
Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowAlert: true,
    shouldPlaySound: true,
    shouldSetBadge: true,
  }),
});

export interface PushNotificationState {
  expoPushToken: string | null;
  notification: Notifications.Notification | null;
  error: string | null;
}

export function usePushNotifications(): PushNotificationState {
  const [expoPushToken, setExpoPushToken] = useState<string | null>(null);
  const [notification, setNotification] = useState<Notifications.Notification | null>(null);
  const [error, setError] = useState<string | null>(null);

  const notificationListener = useRef<Notifications.Subscription>();
  const responseListener = useRef<Notifications.Subscription>();

  const router = useRouter();
  const savePushToken = useMutation(api.users.savePushToken);

  useEffect(() => {
    // –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –¥–ª—è push-—Å–ø–æ–≤—ñ—â–µ–Ω—å
    registerForPushNotificationsAsync()
      .then(async (token) => {
        if (token) {
          setExpoPushToken(token);
          // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ token –≤ –ë–î
          try {
            await savePushToken({ pushToken: token });
          } catch (e) {
            console.error('Error saving push token:', e);
          }
        }
      })
      .catch((err) => {
        setError(err.message);
      });

    // –°–ª—É—Ö–∞—á –≤—Ö—ñ–¥–Ω–∏—Ö —Å–ø–æ–≤—ñ—â–µ–Ω—å (–∫–æ–ª–∏ –¥–æ–¥–∞—Ç–æ–∫ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π)
    notificationListener.current = Notifications.addNotificationReceivedListener((notification) => {
      setNotification(notification);
    });

    // –°–ª—É—Ö–∞—á –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –Ω–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
    responseListener.current = Notifications.addNotificationResponseReceivedListener((response) => {
      handleNotificationResponse(response);
    });

    return () => {
      if (notificationListener.current) {
        Notifications.removeNotificationSubscription(notificationListener.current);
      }
      if (responseListener.current) {
        Notifications.removeNotificationSubscription(responseListener.current);
      }
    };
  }, []);

  // –û–±—Ä–æ–±–∫–∞ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –Ω–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
  const handleNotificationResponse = (response: Notifications.NotificationResponse) => {
    const data = response.notification.request.content.data;

    if (data) {
      switch (data.type) {
        case 'like':
        case 'comment':
          if (data.postId) {
            // –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –ø–æ—Å—Ç–∞ (–ø–æ—Ç—Ä—ñ–±–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –µ–∫—Ä–∞–Ω)
            router.push(`/post/${data.postId}`);
          }
          break;
        case 'follow':
          if (data.userId) {
            router.push(`/user/${data.userId}`);
          }
          break;
        default:
          router.push('/(tabs)/notifications');
      }
    }
  };

  return { expoPushToken, notification, error };
}

// –§—É–Ω–∫—Ü—ñ—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –¥–ª—è push-—Å–ø–æ–≤—ñ—â–µ–Ω—å
async function registerForPushNotificationsAsync(): Promise<string | null> {
  let token: string | null = null;

  // Push-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–∞—Ü—é—é—Ç—å —Ç—ñ–ª—å–∫–∏ –Ω–∞ —Ñ—ñ–∑–∏—á–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö
  if (!Device.isDevice) {
    console.log('Push notifications require a physical device');
    return null;
  }

  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ/–∑–∞–ø–∏—Ç—É—î–º–æ –¥–æ–∑–≤–æ–ª–∏
  const { status: existingStatus } = await Notifications.getPermissionsAsync();
  let finalStatus = existingStatus;

  if (existingStatus !== 'granted') {
    const { status } = await Notifications.requestPermissionsAsync();
    finalStatus = status;
  }

  if (finalStatus !== 'granted') {
    console.log('Permission for push notifications not granted');
    return null;
  }

  // –û—Ç—Ä–∏–º—É—î–º–æ Expo Push Token
  try {
    const projectId = Constants.expoConfig?.extra?.eas?.projectId;

    const pushTokenData = await Notifications.getExpoPushTokenAsync({
      projectId,
    });

    token = pushTokenData.data;
    console.log('Expo Push Token:', token);
  } catch (error) {
    console.error('Error getting push token:', error);
  }

  // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞–Ω–∞–ª—É –¥–ª—è Android
  if (Platform.OS === 'android') {
    await Notifications.setNotificationChannelAsync('default', {
      name: 'default',
      importance: Notifications.AndroidImportance.MAX,
      vibrationPattern: [0, 250, 250, 250],
      lightColor: '#3b82f6',
    });
  }

  return token;
}

// –ï–∫—Å–ø–æ—Ä—Ç—É—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö —Å–ø–æ–≤—ñ—â–µ–Ω—å (—Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è)
export async function sendLocalNotification(
  title: string,
  body: string,
  data?: Record<string, unknown>
) {
  await Notifications.scheduleNotificationAsync({
    content: {
      title,
      body,
      data,
      sound: true,
    },
    trigger: null, // –ù–µ–≥–∞–π–Ω–æ
  });
}
```

### –ö—Ä–æ–∫ 5.2: –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `providers/NotificationProvider.tsx`

```tsx
// providers/NotificationProvider.tsx

import React, { createContext, useContext, ReactNode } from 'react';
import { usePushNotifications, PushNotificationState } from '@/hooks/usePushNotifications';

const NotificationContext = createContext<PushNotificationState | null>(null);

interface NotificationProviderProps {
  children: ReactNode;
}

export function NotificationProvider({ children }: NotificationProviderProps) {
  const pushNotificationState = usePushNotifications();

  return (
    <NotificationContext.Provider value={pushNotificationState}>
      {children}
    </NotificationContext.Provider>
  );
}

export function useNotifications() {
  const context = useContext(NotificationContext);
  if (!context) {
    throw new Error('useNotifications must be used within NotificationProvider');
  }
  return context;
}
```

---

## 6. –û–Ω–æ–≤–ª–µ–Ω–Ω—è Convex —Ñ—É–Ω–∫—Ü—ñ–π

### –ö—Ä–æ–∫ 6.1: –û–Ω–æ–≤—ñ—Ç—å `convex/users.ts`

–î–æ–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü—ñ—é –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è push token:

```typescript
// convex/users.ts

// –î–æ–¥–∞–π—Ç–µ —Ü—é mutation
export const savePushToken = mutation({
  args: { pushToken: v.string() },
  handler: async (ctx, args) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) throw new Error('Not authenticated');

    await ctx.db.patch(userId, {
      pushToken: args.pushToken,
    });
  },
});

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è push token –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
export const getPushToken = query({
  args: { userId: v.id('users') },
  handler: async (ctx, args) => {
    const user = await ctx.db.get(args.userId);
    return user?.pushToken || null;
  },
});

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Å–ø–æ–≤—ñ—â–µ–Ω—å
export const updateNotificationSettings = mutation({
  args: { enabled: v.boolean() },
  handler: async (ctx, args) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) throw new Error('Not authenticated');

    await ctx.db.patch(userId, {
      notificationsEnabled: args.enabled,
    });
  },
});
```

### –ö—Ä–æ–∫ 6.2: –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `convex/pushNotifications.ts`

```typescript
// convex/pushNotifications.ts

import { v } from 'convex/values';
import { action, internalAction } from './_generated/server';
import { internal } from './_generated/api';

// –¢–∏–ø–∏ —Å–ø–æ–≤—ñ—â–µ–Ω—å
type NotificationType = 'like' | 'comment' | 'follow';

interface PushNotificationPayload {
  to: string;
  title: string;
  body: string;
  data?: Record<string, unknown>;
  sound?: string;
  badge?: number;
}

// –í—ñ–¥–ø—Ä–∞–≤–∫–∞ push-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —á–µ—Ä–µ–∑ Expo Push API
export const sendPushNotification = internalAction({
  args: {
    pushToken: v.string(),
    title: v.string(),
    body: v.string(),
    data: v.optional(v.any()),
  },
  handler: async (ctx, args) => {
    const message: PushNotificationPayload = {
      to: args.pushToken,
      title: args.title,
      body: args.body,
      data: args.data,
      sound: 'default',
    };

    try {
      const response = await fetch('https://exp.host/--/api/v2/push/send', {
        method: 'POST',
        headers: {
          Accept: 'application/json',
          'Accept-Encoding': 'gzip, deflate',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(message),
      });

      const result = await response.json();

      if (result.data?.status === 'error') {
        console.error('Push notification error:', result.data.message);
      }

      return result;
    } catch (error) {
      console.error('Failed to send push notification:', error);
      throw error;
    }
  },
});

// –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –ª–∞–π–∫
export const sendLikeNotification = internalAction({
  args: {
    receiverPushToken: v.string(),
    senderUsername: v.string(),
    postId: v.string(),
  },
  handler: async (ctx, args) => {
    await ctx.runAction(internal.pushNotifications.sendPushNotification, {
      pushToken: args.receiverPushToken,
      title: '–ù–æ–≤–∏–π –ª–∞–π–∫ ‚ù§Ô∏è',
      body: `${args.senderUsername} –≤–ø–æ–¥–æ–±–∞–≤(–ª–∞) –≤–∞—à –ø–æ—Å—Ç`,
      data: {
        type: 'like',
        postId: args.postId,
      },
    });
  },
});

// –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –∫–æ–º–µ–Ω—Ç–∞—Ä
export const sendCommentNotification = internalAction({
  args: {
    receiverPushToken: v.string(),
    senderUsername: v.string(),
    postId: v.string(),
    commentPreview: v.string(),
  },
  handler: async (ctx, args) => {
    const preview =
      args.commentPreview.length > 50
        ? args.commentPreview.substring(0, 50) + '...'
        : args.commentPreview;

    await ctx.runAction(internal.pushNotifications.sendPushNotification, {
      pushToken: args.receiverPushToken,
      title: '–ù–æ–≤–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä üí¨',
      body: `${args.senderUsername}: ${preview}`,
      data: {
        type: 'comment',
        postId: args.postId,
      },
    });
  },
});

// –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –ø—ñ–¥–ø–∏—Å–∫—É
export const sendFollowNotification = internalAction({
  args: {
    receiverPushToken: v.string(),
    senderUsername: v.string(),
    senderId: v.string(),
  },
  handler: async (ctx, args) => {
    await ctx.runAction(internal.pushNotifications.sendPushNotification, {
      pushToken: args.receiverPushToken,
      title: '–ù–æ–≤–∏–π –ø—ñ–¥–ø–∏—Å–Ω–∏–∫ üë§',
      body: `${args.senderUsername} –ø—ñ–¥–ø–∏—Å–∞–≤—Å—è(-–ª–∞—Å—å) –Ω–∞ –≤–∞—Å`,
      data: {
        type: 'follow',
        userId: args.senderId,
      },
    });
  },
});
```

### –ö—Ä–æ–∫ 6.3: –û–Ω–æ–≤—ñ—Ç—å `convex/posts.ts` (–ª–∞–π–∫–∏)

–î–æ–¥–∞–π—Ç–µ –≤—ñ–¥–ø—Ä–∞–≤–∫—É push-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–∏ –ª–∞–π–∫—É:

```typescript
// convex/posts.ts

import { internal } from './_generated/api';

export const toggleLike = mutation({
  args: { postId: v.id('posts') },
  handler: async (ctx, args) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) throw new Error('Not authenticated');

    const existingLike = await ctx.db
      .query('likes')
      .withIndex('by_user_and_post', (q) => q.eq('userId', userId).eq('postId', args.postId))
      .first();

    const post = await ctx.db.get(args.postId);
    if (!post) throw new Error('Post not found');

    if (existingLike) {
      // –í–∏–¥–∞–ª—è—î–º–æ –ª–∞–π–∫
      await ctx.db.delete(existingLike._id);
      await ctx.db.patch(args.postId, { likes: post.likes - 1 });
      return false;
    } else {
      // –î–æ–¥–∞—î–º–æ –ª–∞–π–∫
      await ctx.db.insert('likes', { userId, postId: args.postId });
      await ctx.db.patch(args.postId, { likes: post.likes + 1 });

      // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ push-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è (—è–∫—â–æ —Ü–µ –Ω–µ –≤–ª–∞—Å–Ω–∏–π –ø–æ—Å—Ç)
      if (post.userId !== userId) {
        const postOwner = await ctx.db.get(post.userId);
        const currentUser = await ctx.db.get(userId);

        if (postOwner?.pushToken && postOwner.notificationsEnabled !== false && currentUser) {
          await ctx.scheduler.runAfter(0, internal.pushNotifications.sendLikeNotification, {
            receiverPushToken: postOwner.pushToken,
            senderUsername: currentUser.username,
            postId: args.postId,
          });
        }

        // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–ø–∏—Å —É notifications
        await ctx.db.insert('notifications', {
          receiverId: post.userId,
          senderId: userId,
          type: 'like',
          postId: args.postId,
        });
      }

      return true;
    }
  },
});
```

### –ö—Ä–æ–∫ 6.4: –û–Ω–æ–≤—ñ—Ç—å `convex/comments.ts`

```typescript
// convex/comments.ts

import { internal } from './_generated/api';

export const addComment = mutation({
  args: {
    postId: v.id('posts'),
    content: v.string(),
  },
  handler: async (ctx, args) => {
    const userId = await getAuthUserId(ctx);
    if (!userId) throw new Error('Not authenticated');

    const post = await ctx.db.get(args.postId);
    if (!post) throw new Error('Post not found');

    // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–º–µ–Ω—Ç–∞—Ä
    const commentId = await ctx.db.insert('comments', {
      userId,
      postId: args.postId,
      content: args.content,
    });

    // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤
    await ctx.db.patch(args.postId, { comments: post.comments + 1 });

    // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ push-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è (—è–∫—â–æ —Ü–µ –Ω–µ –≤–ª–∞—Å–Ω–∏–π –ø–æ—Å—Ç)
    if (post.userId !== userId) {
      const postOwner = await ctx.db.get(post.userId);
      const currentUser = await ctx.db.get(userId);

      if (postOwner?.pushToken && postOwner.notificationsEnabled !== false && currentUser) {
        await ctx.scheduler.runAfter(0, internal.pushNotifications.sendCommentNotification, {
          receiverPushToken: postOwner.pushToken,
          senderUsername: currentUser.username,
          postId: args.postId,
          commentPreview: args.content,
        });
      }

      // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–ø–∏—Å —É notifications
      await ctx.db.insert('notifications', {
        receiverId: post.userId,
        senderId: userId,
        type: 'comment',
        postId: args.postId,
        commentId,
      });
    }

    return commentId;
  },
});
```

### –ö—Ä–æ–∫ 6.5: –û–Ω–æ–≤—ñ—Ç—å `convex/users.ts` (–ø—ñ–¥–ø–∏—Å–∫–∏)

```typescript
// convex/users.ts

import { internal } from './_generated/api';

export const toggleFollow = mutation({
  args: { userId: v.id('users') },
  handler: async (ctx, args) => {
    const currentUserId = await getAuthUserId(ctx);
    if (!currentUserId) throw new Error('Not authenticated');

    if (currentUserId === args.userId) {
      throw new Error('Cannot follow yourself');
    }

    const existingFollow = await ctx.db
      .query('follows')
      .withIndex('by_both', (q) => q.eq('followerId', currentUserId).eq('followingId', args.userId))
      .first();

    const targetUser = await ctx.db.get(args.userId);
    const currentUser = await ctx.db.get(currentUserId);

    if (!targetUser || !currentUser) throw new Error('User not found');

    if (existingFollow) {
      // –í—ñ–¥–ø–∏—Å—É—î–º–æ—Å—å
      await ctx.db.delete(existingFollow._id);
      await ctx.db.patch(args.userId, { followers: targetUser.followers - 1 });
      await ctx.db.patch(currentUserId, { following: currentUser.following - 1 });
      return false;
    } else {
      // –ü—ñ–¥–ø–∏—Å—É—î–º–æ—Å—å
      await ctx.db.insert('follows', {
        followerId: currentUserId,
        followingId: args.userId,
      });
      await ctx.db.patch(args.userId, { followers: targetUser.followers + 1 });
      await ctx.db.patch(currentUserId, { following: currentUser.following + 1 });

      // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ push-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
      if (targetUser.pushToken && targetUser.notificationsEnabled !== false) {
        await ctx.scheduler.runAfter(0, internal.pushNotifications.sendFollowNotification, {
          receiverPushToken: targetUser.pushToken,
          senderUsername: currentUser.username,
          senderId: currentUserId,
        });
      }

      // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–ø–∏—Å —É notifications
      await ctx.db.insert('notifications', {
        receiverId: args.userId,
        senderId: currentUserId,
        type: 'follow',
      });

      return true;
    }
  },
});
```

---

## 7. –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –≤ –¥–æ–¥–∞—Ç–æ–∫

### –û–Ω–æ–≤—ñ—Ç—å `app/_layout.tsx`

```tsx
// app/_layout.tsx

import { Stack } from 'expo-router';
import { ClerkAndConvexProvider } from '@/providers/ClerkAndConvexProvider';
import { NotificationProvider } from '@/providers/NotificationProvider';
import { InitialLayout } from '@/components/InitialLayout';

export default function RootLayout() {
  return (
    <ClerkAndConvexProvider>
      <NotificationProvider>
        <InitialLayout>
          <Stack screenOptions={{ headerShown: false }}>
            <Stack.Screen name="(tabs)" />
            <Stack.Screen name="(auth)" />
            <Stack.Screen name="user/[id]" />
            {/* ... —ñ–Ω—à—ñ –µ–∫—Ä–∞–Ω–∏ */}
          </Stack>
        </InitialLayout>
      </NotificationProvider>
    </ClerkAndConvexProvider>
  );
}
```

---

## 8. –û–±—Ä–æ–±–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω—å

### –ö—Ä–æ–∫ 8.1: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Å–ø–æ–≤—ñ—â–µ–Ω—å

```tsx
// components/NotificationSettings.tsx

import { View, Text, Switch, StyleSheet } from 'react-native';
import { useMutation, useQuery } from 'convex/react';
import { api } from '@/convex/_generated/api';
import { COLORS } from '@/constants/theme';
import { useUser } from '@clerk/clerk-expo';

export const NotificationSettings = () => {
  const { user } = useUser();
  const currentUser = useQuery(api.users.getUserByClerkId, user ? { clerkId: user.id } : 'skip');
  const updateSettings = useMutation(api.users.updateNotificationSettings);

  const isEnabled = currentUser?.notificationsEnabled !== false;

  const handleToggle = async (value: boolean) => {
    try {
      await updateSettings({ enabled: value });
    } catch (error) {
      console.error('Error updating notification settings:', error);
    }
  };

  return (
    <View style={styles.container}>
      <View style={styles.row}>
        <View>
          <Text style={styles.title}>Push-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</Text>
          <Text style={styles.subtitle}>
            –û—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –ª–∞–π–∫–∏, –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ —Ç–∞ –ø—ñ–¥–ø–∏—Å–∫–∏
          </Text>
        </View>
        <Switch
          value={isEnabled}
          onValueChange={handleToggle}
          trackColor={{ false: COLORS.grey, true: COLORS.primary }}
          thumbColor={COLORS.white}
        />
      </View>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    padding: 16,
    backgroundColor: COLORS.background,
  },
  row: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  title: {
    fontSize: 16,
    fontWeight: '600',
    color: COLORS.white,
  },
  subtitle: {
    fontSize: 12,
    color: COLORS.grey,
    marginTop: 4,
    maxWidth: 250,
  },
});
```

### –ö—Ä–æ–∫ 8.2: –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è in-app —Å–ø–æ–≤—ñ—â–µ–Ω—å

```tsx
// components/InAppNotification.tsx

import { useEffect, useState } from 'react';
import { View, Text, StyleSheet, Animated, TouchableOpacity } from 'react-native';
import { useNotifications } from '@/providers/NotificationProvider';
import { COLORS } from '@/constants/theme';
import { Ionicons } from '@expo/vector-icons';

export const InAppNotification = () => {
  const { notification } = useNotifications();
  const [visible, setVisible] = useState(false);
  const translateY = useState(new Animated.Value(-100))[0];

  useEffect(() => {
    if (notification) {
      setVisible(true);

      // –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–æ—è–≤–∏
      Animated.spring(translateY, {
        toValue: 0,
        useNativeDriver: true,
        tension: 50,
        friction: 8,
      }).start();

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥–∏
      const timer = setTimeout(() => {
        hideNotification();
      }, 4000);

      return () => clearTimeout(timer);
    }
  }, [notification]);

  const hideNotification = () => {
    Animated.timing(translateY, {
      toValue: -100,
      duration: 300,
      useNativeDriver: true,
    }).start(() => setVisible(false));
  };

  if (!visible || !notification) return null;

  const { title, body } = notification.request.content;

  return (
    <Animated.View style={[styles.container, { transform: [{ translateY }] }]}>
      <TouchableOpacity style={styles.content} onPress={hideNotification}>
        <Ionicons name="notifications" size={24} color={COLORS.primary} />
        <View style={styles.textContainer}>
          <Text style={styles.title} numberOfLines={1}>
            {title}
          </Text>
          <Text style={styles.body} numberOfLines={2}>
            {body}
          </Text>
        </View>
        <TouchableOpacity onPress={hideNotification}>
          <Ionicons name="close" size={20} color={COLORS.grey} />
        </TouchableOpacity>
      </TouchableOpacity>
    </Animated.View>
  );
};

const styles = StyleSheet.create({
  container: {
    position: 'absolute',
    top: 50,
    left: 16,
    right: 16,
    zIndex: 1000,
  },
  content: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#1a1a1a',
    borderRadius: 12,
    padding: 12,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.3,
    shadowRadius: 8,
    elevation: 8,
  },
  textContainer: {
    flex: 1,
    marginHorizontal: 12,
  },
  title: {
    fontSize: 14,
    fontWeight: '600',
    color: COLORS.white,
  },
  body: {
    fontSize: 12,
    color: COLORS.grey,
    marginTop: 2,
  },
});
```

---

## 9. –ß–µ–∫-–ª–∏—Å—Ç –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è

### –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è:

- [ ] `npx expo install expo-notifications expo-device expo-constants`
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ —ñ–∫–æ–Ω–∫—É `assets/images/notification-icon.png` (96x96)

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:

- [ ] –û–Ω–æ–≤–∏—Ç–∏ `app.config.ts`
- [ ] –û–Ω–æ–≤–∏—Ç–∏ `convex/schema.ts` (–¥–æ–¥–∞—Ç–∏ `pushToken`, `notificationsEnabled`)

### –ö–æ–¥:

- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `hooks/usePushNotifications.ts`
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `providers/NotificationProvider.tsx`
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `convex/pushNotifications.ts`
- [ ] –û–Ω–æ–≤–∏—Ç–∏ `convex/users.ts` (savePushToken, toggleFollow)
- [ ] –û–Ω–æ–≤–∏—Ç–∏ `convex/posts.ts` (toggleLike)
- [ ] –û–Ω–æ–≤–∏—Ç–∏ `convex/comments.ts` (addComment)
- [ ] –û–Ω–æ–≤–∏—Ç–∏ `app/_layout.tsx`

### –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ:

- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `components/NotificationSettings.tsx`
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ `components/InAppNotification.tsx`

### –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è:

- [ ] `npx convex dev`
- [ ] –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–∞ —Ñ—ñ–∑–∏—á–Ω–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó (–µ–º—É–ª—è—Ç–æ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î push)
- [ ] –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è token
- [ ] –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—ñ–¥–ø—Ä–∞–≤–∫—É —Å–ø–æ–≤—ñ—â–µ–Ω—å

---

## –í–∞–∂–ª–∏–≤—ñ –ø—Ä–∏–º—ñ—Ç–∫–∏

### 1. Push-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–∞—Ü—é—é—Ç—å —Ç—ñ–ª—å–∫–∏ –Ω–∞ —Ñ—ñ–∑–∏—á–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö

–ï–º—É–ª—è—Ç–æ—Ä–∏ iOS —Ç–∞ Android –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å push-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è.

### 2. Expo Push Token

- –î–ª—è development builds –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `expo-dev-client`
- –î–ª—è production –ø–æ—Ç—Ä—ñ–±–µ–Ω EAS Build

### 3. Rate Limits

Expo Push API –º–∞—î –ª—ñ–º—ñ—Ç–∏:

- 600 —Å–ø–æ–≤—ñ—â–µ–Ω—å/—Ö–≤–∏–ª–∏–Ω—É –¥–ª—è –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ–≥–æ –ø–ª–∞–Ω—É
- –î–ª—è –±—ñ–ª—å—à–∏—Ö –æ–±—Å—è–≥—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ batch sending

### 4. –ü–æ–º–∏–ª–∫–∏ —Ç–æ–∫–µ–Ω—ñ–≤

–Ø–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∏–¥–∞–ª–∏–≤ –¥–æ–¥–∞—Ç–æ–∫), Expo –ø–æ–≤–µ—Ä–Ω–µ –ø–æ–º–∏–ª–∫—É. –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –≤–∏–¥–∞–ª—è—Ç–∏ –Ω–µ–¥—ñ–π—Å–Ω—ñ —Ç–æ–∫–µ–Ω–∏ –∑ –ë–î.

### 5. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏:

```typescript
import { sendLocalNotification } from '@/hooks/usePushNotifications';

// –¢–µ—Å—Ç–æ–≤–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
sendLocalNotification('–¢–µ—Å—Ç', '–¶–µ —Ç–µ—Å—Ç–æ–≤–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è', { type: 'test' });
```

---

## –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ—Å—É—Ä—Å–∏

- [Expo Notifications Documentation](https://docs.expo.dev/versions/latest/sdk/notifications/)
- [Expo Push API](https://docs.expo.dev/push-notifications/overview/)
- [FCM Setup for Android](https://docs.expo.dev/push-notifications/fcm-credentials/)
- [APNs Setup for iOS](https://docs.expo.dev/push-notifications/push-notifications-setup/)
